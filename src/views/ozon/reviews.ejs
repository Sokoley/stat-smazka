<%- include('../layouts/main', { title, body: `
  <style>
    /* –í—Å—Ç–∞–≤–ª–µ–Ω—ã —Å—Ç–∏–ª–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π PHP-—Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
    }
    
    .ozon-reviews-container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    
    .ozon-reviews-container header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .ozon-reviews-container h1 {
      color: #000000ff;
      margin-bottom: 10px;
    }
    
    .ozon-reviews-container h2 {
      color: #333;
      margin: 25px 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .ozon-reviews-container h3 {
      color: #005bff;
      margin: 20px 0 10px 0;
    }
    
    .description {
      color: #666;
      margin-bottom: 20px;
    }
    
    .search-section {
      margin-bottom: 20px;
    }
    
    .search-container {
      position: relative;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 45px 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #005bff;
      box-shadow: 0 0 0 3px rgba(0, 91, 255, 0.1);
    }
    
    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #666;
      font-size: 18px;
    }
    
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    
    .search-result-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .search-result-item:hover {
      background-color: #f8f9fa;
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-product-image {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 10px;
      text-align: center;
    }
    
    .search-product-info {
      flex: 1;
    }
    
    .product-name-search {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .product-sku {
      font-size: 12px;
      color: #666;
    }
    
    .selected-product {
      display: none;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f0f7ff;
      border-radius: 10px;
      border: 2px solid #005bff;
    }
    
    .selected-product-image {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 14px;
      text-align: center;
    }
    
    .selected-product-info {
      flex: 1;
    }
    
    .selected-product-name {
      font-size: 24px;
      font-weight: bold;
      color: #005bff;
      margin-bottom: 5px;
    }
    
    .selected-product-sku {
      color: #666;
      font-size: 14px;
    }
    
    .selected-product-reviews {
      color: #666;
      font-size: 16px;
      margin-top: 5px;
    }
    
    .product-selection {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      align-items: flex-end;
    }
    
    .product-select-group {
      flex: 1;
      display: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }
    
    select, button {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    
    select {
      width: 100%;
    }
    
    button {
      background-color: #005bff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
      white-space: nowrap;
    }
    
    button:hover {
      background-color: #0048d9;
    }
    
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .download-btn {
      background-color: #28a745;
    }
    
    .download-btn:hover {
      background-color: #218838;
    }
    
    .analyze-btn {
      background-color: #ff6b00;
    }
    
    .analyze-btn:hover {
      background-color: #e55a00;
    }
    
    .update-btn {
      background-color: #6f42c1;
    }
    
    .update-btn:hover {
      background-color: #5e34b1;
    }
    
    .analytics-section {
      display: none;
      margin: 30px 0;
    }
    
    .analytics-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .analytics-title {
      font-size: 28px;
      font-weight: bold;
      color: #005bff;
      margin: 0;
    }
    
    .analytics-loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #005bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .analytics-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 4px solid #005bff;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .category-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    
    .category-name {
      font-weight: 500;
    }
    
    .category-percentage {
      font-weight: bold;
      color: #28a745;
      background: #e8f5e8;
      padding: 3px 10px;
      border-radius: 15px;
    }
    
    .comparison-better {
      color: #28a745;
      background: #e8f5e8;
    }
    
    .comparison-worse {
      color: #dc3545;
      background: #f8e8e8;
    }
    
    .gender-stats {
      display: flex;
      justify-content: space-around;
      margin-top: 15px;
    }
    
    .gender-item {
      text-align: center;
      padding: 10px;
    }
    
    .gender-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .gender-male {
      color: #007bff;
    }
    
    .gender-female {
      color: #e83e8c;
    }
    
    .gender-percentage {
      font-size: 18px;
      font-weight: bold;
    }
    
    .gender-label {
      font-size: 12px;
      color: #666;
    }
    
    .rating-stats {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }
    
    .rating-stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 5px 0;
    }
    
    .rating-stars {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .rating-count {
      font-weight: bold;
      color: #005bff;
    }
    
    .loading-progress {
      background: #f0f7ff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      text-align: center;
    }
    
    .progress-text {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .progress-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #005bff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    .reviews-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      overflow-y: auto;
    }
    
    .modal-content {
      background: white;
      margin: 50px auto;
      padding: 20px;
      border-radius: 10px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #005bff;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .modal-reviews {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .reviews-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }
    
    .review-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 15px;
      transition: transform 0.3s;
      border-left: 4px solid #005bff;
    }
    
    .review-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .product-info {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .product-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 10px;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 12px;
      text-align: center;
    }
    
    .product-name {
      font-weight: 600;
      flex: 1;
    }
    
    .rating {
      display: flex;
      margin-bottom: 10px;
    }
    
    .star {
      color: #ffc107;
      margin-right: 2px;
      font-size: 18px;
    }
    
    .review-text {
      margin-bottom: 10px;
      line-height: 1.5;
      background-color: #f9f9f9;
      padding: 10px;
      border-radius: 5px;
      border-left: 3px solid #e0e0e0;
    }
    
    .review-meta {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #777;
    }
    
    .status {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-published {
      background-color: #e7f7ef;
      color: #0a8754;
    }
    
    .status-unpublished {
      background-color: #fef3e2;
      color: #b54708;
    }
    
    .no-reviews {
      text-align: center;
      padding: 40px;
      color: #777;
      grid-column: 1 / -1;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      grid-column: 1 / -1;
    }
    
    .error {
      background-color: #fee;
      color: #c33;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .success {
      background-color: #efe;
      color: #3c3;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .media-count {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    
    .media-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    @media (max-width: 768px) {
      .product-selection {
        flex-direction: column;
        align-items: stretch;
      }
      
      .action-buttons {
        flex-direction: column;
        margin-left: 0;
      }
      
      .reviews-container {
        grid-template-columns: 1fr;
      }
      
      .analytics-grid {
        grid-template-columns: 1fr;
      }
      
      .gender-stats {
        flex-direction: column;
      }
      
      .selected-product {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>

  <div class="ozon-reviews-container">
    <header>
      <h1>–û—Ç–∑—ã–≤—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π OZON</h1>
      <p class="description">–ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ —Ç–æ–≤–∞—Ä—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π. –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Ç–∑—ã–≤—ã —Å —Ç–µ–∫—Å—Ç–æ–º.</p>
    </header>
    
    <div class="search-section">
      <div class="search-container">
        <input type="text" id="product-search" class="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
        <div class="search-icon">üîç</div>
        <div class="search-results" id="search-results"></div>
      </div>
    </div>
    
    <div class="selected-product" id="selected-product">
      <div class="selected-product-image" id="selected-product-image">–ù–µ—Ç —Ñ–æ—Ç–æ</div>
      <div class="selected-product-info">
        <div class="selected-product-name" id="selected-product-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</div>
        <div class="selected-product-sku" id="selected-product-sku">SKU: </div>
        <div class="selected-product-reviews" id="selected-product-reviews"></div>
      </div>
    </div>
    
    <div class="loading-progress" id="loading-progress">
      <div class="progress-text" id="progress-text">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</div>
      <div class="progress-spinner"></div>
    </div>
    
    <div class="product-selection">
      <div class="product-select-group">
        <label for="product-select">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä:</label>
        <select id="product-select">
          <option value="">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</option>
        </select>
      </div>
      <div class="action-buttons">
        <button id="update-btn" class="update-btn" style="display: none !important;">–û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–∑—ã–≤—ã –∏–∑ OZON</button>
        <button id="download-btn" class="download-btn" style="display: none !important;">–°–∫–∞—á–∞—Ç—å –æ—Ç–∑—ã–≤—ã</button>
        <button id="analyze-btn" class="analyze-btn">–ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤</button>
      </div>
    </div>
    
    <div id="error-message" class="error" style="display: none;"></div>
    <div id="success-message" class="success" style="display: none;"></div>
    
    <div class="analytics-section" id="analytics-section">
      <div class="analytics-header">
        <h2 class="analytics-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ—Ç–∑—ã–≤–æ–≤</h2>
      </div>
      <div id="analytics-content"></div>
    </div>
    
    <div class="reviews-container" id="reviews-container">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ -->
  <div class="reviews-modal" id="reviews-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">–û—Ç–∑—ã–≤—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <button class="close-modal" id="close-modal">&times;</button>
      </div>
      <div class="modal-reviews" id="modal-reviews"></div>
    </div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
    const API_CONFIG = {
      apiKey: '5cf6e47b-0f73-4b23-b8cd-6a097e7cd60d',
      clientId: '106736',
      baseUrl: 'https://api-seller.ozon.ru',
      deepSeekProxyUrl: '/ozon/reviews/api-proxy.php',
      serverUrl: '/ozon/reviews/update_reviews.php'
    };

    let allReviews = [];
    let productsMap = new Map();
    let filteredReviews = [];
    let currentAnalysis = null;
    let currentSelectedProduct = null;
    let reviewCategories = new Map();

    const productSelect = document.getElementById('product-select');
    const downloadBtn = document.getElementById('download-btn');
    const analyzeBtn = document.getElementById('analyze-btn');
    const updateBtn = document.getElementById('update-btn');
    const reviewsContainer = document.getElementById('reviews-container');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const analyticsSection = document.getElementById('analytics-section');
    const analyticsContent = document.getElementById('analytics-content');
    const productSearch = document.getElementById('product-search');
    const searchResults = document.getElementById('search-results');
    const reviewsModal = document.getElementById('reviews-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalReviews = document.getElementById('modal-reviews');
    const closeModal = document.getElementById('close-modal');
    const selectedProductElement = document.getElementById('selected-product');
    const selectedProductImage = document.getElementById('selected-product-image');
    const selectedProductName = document.getElementById('selected-product-name');
    const selectedProductSku = document.getElementById('selected-product-sku');
    const selectedProductReviews = document.getElementById('selected-product-reviews');
    const loadingProgress = document.getElementById('loading-progress');
    const progressText = document.getElementById('progress-text');

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const loadedFromServer = await loadReviewsFromServer();
        
        if (!loadedFromServer || allReviews.length === 0) {
          showInfo('–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ OZON API...');
          await updateReviewsOnServer();
        } else {
          showSuccess('–ó–∞–≥—Ä—É–∂–µ–Ω–æ ' + allReviews.length + ' –æ—Ç–∑—ã–≤–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞');
        }
        
        await fetchProductsInfo();
        populateProductSelect();
        displayReviews(allReviews);
        
        downloadBtn.addEventListener('click', downloadReviews);
        analyzeBtn.addEventListener('click', analyzeProductUsage);
        updateBtn.addEventListener('click', updateReviewsOnServer);
        productSelect.addEventListener('change', handleProductChange);
        productSearch.addEventListener('input', handleSearch);
        
        closeModal.addEventListener('click', closeReviewsModal);
        reviewsModal.addEventListener('click', (e) => {
          if (e.target === reviewsModal) {
            closeReviewsModal();
          }
        });
        
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.search-container')) {
            searchResults.style.display = 'none';
          }
        });
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
      }
    });

    async function loadReviewsFromServer() {
      try {
        const response = await fetch(API_CONFIG.serverUrl);
        const result = await response.json();
        
        if (result.success && result.data) {
          allReviews = result.data.reviews || [];
          console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ ' + allReviews.length + ' –æ—Ç–∑—ã–≤–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞');
          return true;
        } else {
          throw new Error(result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∑—ã–≤—ã —Å —Å–µ—Ä–≤–µ—Ä–∞');
        }
      } catch (error) {
        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error.message);
        return false;
      }
    }

    async function updateReviewsOnServer() {
      try {
        showInfo('–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –∏–∑ OZON API –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...');
        
        const response = await fetch(API_CONFIG.serverUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          await loadReviewsFromServer();
          await fetchProductsInfo();
          populateProductSelect();
          displayReviews(allReviews);
          
          showSuccess('–û—Ç–∑—ã–≤—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã! ' + result.data.totalCount + ' –æ—Ç–∑—ã–≤–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
          return true;
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–æ–≤: ' + error.message);
        return false;
      }
    }

    function closeReviewsModal() {
      reviewsModal.style.display = 'none';
    }

    function handleSearch(e) {
      const searchTerm = e.target.value.trim().toLowerCase();
      
      if (searchTerm.length < 2) {
        searchResults.style.display = 'none';
        return;
      }
      
      const filteredProducts = Array.from(productsMap.entries())
        .filter(([sku, product]) => 
          product.name.toLowerCase().includes(searchTerm)
        )
        .slice(0, 10);
      
      displaySearchResults(filteredProducts);
    }

    function displaySearchResults(products) {
      if (products.length === 0) {
        searchResults.innerHTML = '<div class="search-result-item">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        searchResults.style.display = 'block';
        return;
      }
      
      searchResults.innerHTML = products.map(([sku, product]) =>
        '<div class="search-result-item" data-sku="' + sku + '">' +
          '<div class="search-product-image">' +
            (product.image ? '<img src="' + product.image + '" alt="' + product.name + '" style="width:100%;height:100%;object-fit:cover;">' : '–ù–µ—Ç —Ñ–æ—Ç–æ') +
          '</div>' +
          '<div class="search-product-info">' +
            '<div class="product-name-search">' + highlightSearchTerm(product.name, productSearch.value) + '</div>' +
            '<div class="product-sku">SKU: ' + sku + '</div>' +
          '</div>' +
        '</div>'
      ).join('');
      
      searchResults.style.display = 'block';
      
      searchResults.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const sku = item.getAttribute('data-sku');
          selectProductFromSearch(sku);
        });
      });
    }

    function highlightSearchTerm(text, searchTerm) {
      if (!searchTerm) return text;
      const regex = new RegExp('(' + searchTerm + ')', 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function selectProductFromSearch(sku) {
      currentSelectedProduct = sku;
      const product = productsMap.get(sku);
      
      const productReviewsCount = allReviews.filter(review => 
        review.sku.toString() === sku
      ).length;
      
      selectedProductName.textContent = product.name;
      selectedProductSku.textContent = 'SKU: ' + sku;
      selectedProductReviews.textContent = productReviewsCount + ' –æ—Ç–∑—ã–≤–æ–≤';
      
      if (product.image) {
        selectedProductImage.innerHTML = '<img src="' + product.image + '" alt="' + product.name + '" style="width:100%;height:100%;object-fit:cover;">';
      } else {
        selectedProductImage.textContent = '–ù–µ—Ç —Ñ–æ—Ç–æ';
      }
      
      selectedProductElement.style.display = 'flex';
      productSearch.value = product.name;
      searchResults.style.display = 'none';
      
      downloadBtn.style.display = 'block';
      analyzeBtn.style.display = 'block';
      analyticsSection.style.display = 'none';
      
      filteredReviews = allReviews.filter(review => 
        review.sku.toString() === sku
      );
      displayReviews(filteredReviews);
    }

    function handleProductChange() {
      const selectedProduct = productSelect.value;
      
      if (selectedProduct) {
        downloadBtn.style.display = 'block';
        analyzeBtn.style.display = 'block';
        analyticsSection.style.display = 'none';
        
        filteredReviews = allReviews.filter(review => 
          review.sku.toString() === selectedProduct
        );
        displayReviews(filteredReviews);
      } else {
        downloadBtn.style.display = 'none';
        analyzeBtn.style.display = 'none';
        analyticsSection.style.display = 'none';
        selectedProductElement.style.display = 'none';
        displayReviews(allReviews);
      }
    }

    async function analyzeProductUsage() {
      if (!currentSelectedProduct) {
        showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
        return;
      }
      
      const productReviews = allReviews.filter(review => 
        review.sku.toString() === currentSelectedProduct
      );
      
      if (productReviews.length === 0) {
        showError('–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
        return;
      }
      
      analyticsSection.style.display = 'block';
      analyticsContent.innerHTML =
        '<div class="analytics-loading">' +
          '<div class="spinner"></div>' +
          '<p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º ' + productReviews.length + ' –æ—Ç–∑—ã–≤–æ–≤ —Å –ø–æ–º–æ—â—å—é DeepSeek AI...</p>' +
          '<p>–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</p>' +
        '</div>';
      
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = '–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
      
      try {
        const analysis = await getDeepSeekAnalysis(productReviews);
        currentAnalysis = analysis;
        displayUsageAnalysis(analysis, productReviews);
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç–∑—ã–≤–æ–≤: ' + error.message);
        analyticsContent.innerHTML = '';
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = '–ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤';
      }
    }

    async function getDeepSeekAnalysis(reviews) {
      console.log('–ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ –¥–ª—è', reviews.length, '–æ—Ç–∑—ã–≤–æ–≤');
      
      reviewCategories.clear();

      const reviewsText = reviews.map(function(review, index) {
        return (index + 1) + '. –†–µ–π—Ç–∏–Ω–≥ ' + review.rating + '/5: ' + review.text;
      }).join('\\n\\n');

      const prompt = '–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –æ—Ç–∑—ã–≤–æ–≤. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ –æ—Ç–∑—ã–≤—ã –∏ –≤–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –æ–±—ä–µ–∫—Ç –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –¥—Ä—É–≥–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.\\n\\n' +
        '–û–¢–ó–´–í–´ (' + reviews.length + ' —à—Ç.):\\n' +
        reviewsText + '\\n\\n' +
        '–ê–ù–ê–õ–ò–¢–ò–ö–ê –í –§–û–†–ú–ê–¢–ï JSON:\\n' +
        '1. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏, —Å—É–º–º–∞ 100%)\\n' +
        '2. –î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞ (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏, —Å—É–º–º–∞ 100%)\\n' +
        '3. –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ —Ç–æ–≤–∞—Ä–∞ (–ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏, —Å—É–º–º–∞ 100%)\\n' +
        '4. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –ø–æ –ø–æ–ª—É (–º—É–∂—á–∏–Ω—ã/–∂–µ–Ω—â–∏–Ω—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)\\n' +
        '5. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–æ—Ç–∫—É–¥–∞ —É–∑–Ω–∞–ª–∏ –æ —Ç–æ–≤–∞—Ä–µ, —Å—É–º–º–∞ 100%)\\n' +
        '6. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏ (—É–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥—Ä—É–≥–∏—Ö –±—Ä–µ–Ω–¥–æ–≤)\\n' +
        '7. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ (—Å–∫–æ–ª—å–∫–æ –æ—Ç–∑—ã–≤–æ–≤ —Å –∫–∞–∂–¥–æ–π –æ—Ü–µ–Ω–∫–æ–π)\\n\\n' +
        '–í–ï–†–ù–ò –¢–û–õ–¨–ö–û JSON:\\n' +
        '{\\n' +
        '  "usage": [\\n    {"name": "–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è", "percentage": —á–∏—Å–ª–æ, "review_ids": [–Ω–æ–º–µ—Ä–∞]}\\n  ],\\n' +
        '  "advantages": [\\n    {"name": "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞", "percentage": —á–∏—Å–ª–æ, "review_ids": [–Ω–æ–º–µ—Ä–∞]}\\n  ],\\n' +
        '  "disadvantages": [\\n    {"name": "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞", "percentage": —á–∏—Å–ª–æ, "review_ids": [–Ω–æ–º–µ—Ä–∞]}\\n  ],\\n' +
        '  "gender_distribution": {\\n    "male": —á–∏—Å–ª–æ,\\n    "female": —á–∏—Å–ª–æ\\n  },\\n' +
        '  "discovery_sources": [\\n    {"name": "–ò—Å—Ç–æ—á–Ω–∏–∫", "percentage": —á–∏—Å–ª–æ, "review_ids": [–Ω–æ–º–µ—Ä–∞]}\\n  ],\\n' +
        '  "competitor_comparison": [\\n    {"name": "–ë—Ä–µ–Ω–¥ - –ª—É—á—à–µ", "percentage": —á–∏—Å–ª–æ, "review_ids": [–Ω–æ–º–µ—Ä–∞]},\\n    {"name": "–ë—Ä–µ–Ω–¥ - —Ö—É–∂–µ", "percentage": —á–∏—Å–ª–æ, "review_ids": [–Ω–æ–º–µ—Ä–∞]}\\n  ],\\n' +
        '  "rating_distribution": {\\n    "1": —á–∏—Å–ª–æ,\\n    "2": —á–∏—Å–ª–æ,\\n    "3": —á–∏—Å–ª–æ,\\n    "4": —á–∏—Å–ª–æ,\\n    "5": —á–∏—Å–ª–æ\\n  }\\n' +
        '}';

      try {
        const payload = {
          model: 'deepseek-chat',
          messages: [
            { 
              role: 'system', 
              content: '–¢—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON. –ù–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.' 
            },
            { 
              role: 'user', 
              content: prompt 
            }
          ],
          max_tokens: 4000,
          temperature: 0.1,
          response_format: { type: "json_object" }
        };

        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ DeepSeek...');
        
        const response = await fetch(API_CONFIG.deepSeekProxyUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞:', errorText);
          throw new Error('–û—à–∏–±–∫–∞ API: ' + response.status);
        }

        const data = await response.json();
        console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç DeepSeek:', data);
        
        if (!data || !data.choices || !data.choices[0] || !data.choices[0].message) {
          console.error('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:', data);
          throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç DeepSeek');
        }
        
        const responseContent = data.choices[0].message.content;
        console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞:', responseContent);
        
        let parsedAnalysis;
        try {
          parsedAnalysis = JSON.parse(responseContent);
        } catch (parseError) {
          console.warn('–ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å JSON...');
          
          const jsonMatch = responseContent.match(/\{[\s\S]*\}/);
          if (jsonMatch) {
            try {
              parsedAnalysis = JSON.parse(jsonMatch[0]);
            } catch (secondError) {
              console.error('–í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å:', secondError);
              throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞');
            }
          } else {
            throw new Error('JSON –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ');
          }
        }
        
        if (!parsedAnalysis.usage) parsedAnalysis.usage = [];
        if (!parsedAnalysis.advantages) parsedAnalysis.advantages = [];
        if (!parsedAnalysis.disadvantages) parsedAnalysis.disadvantages = [];
        if (!parsedAnalysis.gender_distribution) {
          parsedAnalysis.gender_distribution = { male: 50, female: 50 };
        }
        if (!parsedAnalysis.discovery_sources) parsedAnalysis.discovery_sources = [];
        if (!parsedAnalysis.competitor_comparison) parsedAnalysis.competitor_comparison = [];
        if (!parsedAnalysis.rating_distribution) {
          parsedAnalysis.rating_distribution = { "1": 0, "2": 0, "3": 0, "4": 0, "5": 0 };
        }
        
        saveReviewCategories(parsedAnalysis, reviews);
        
        console.log('–ê–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω');
        return parsedAnalysis;
        
      } catch (error) {
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ:', error);
        throw error;
      }
    }

    function saveReviewCategories(analysis, reviews) {
      reviewCategories.clear();
      
      if (!analysis || !reviews) {
        console.warn('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
        return;
      }
      
      const categories = [
        { key: 'usage', data: analysis.usage || [] },
        { key: 'advantages', data: analysis.advantages || [] },
        { key: 'disadvantages', data: analysis.disadvantages || [] },
        { key: 'discovery_sources', data: analysis.discovery_sources || [] },
        { key: 'competitor_comparison', data: analysis.competitor_comparison || [] }
      ];
      
      categories.forEach(category => {
        if (category.data && Array.isArray(category.data)) {
          category.data.forEach(item => {
            if (item && item.name) {
              const categoryKey = (category.key + '_' + item.name).replace(/[^a-zA-Z0-9_]/g, '_');
              
              if (item.review_ids && Array.isArray(item.review_ids)) {
                const categoryReviews = item.review_ids
                  .map(id => {
                    const reviewIndex = Math.max(0, Math.min(id - 1, reviews.length - 1));
                    return reviews[reviewIndex];
                  })
                  .filter(review => review && review.text && review.text.trim().length > 0)
                  .slice(0, 5);
                
                if (categoryReviews.length > 0) {
                  reviewCategories.set(categoryKey, categoryReviews);
                }
              }
            }
          });
        }
      });
      
      console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', reviewCategories.size);
    }

    function createStars(rating, count = 5) {
      let starsHtml = '';
      for (let i = 1; i <= count; i++) {
        if (i <= rating) {
          starsHtml += '<span class="star">‚òÖ</span>';
        } else {
          starsHtml += '<span class="star" style="color: #ddd">‚òÖ</span>';
        }
      }
      return starsHtml;
    }

    function displayUsageAnalysis(analysis, reviews) {
      if (!analysis) {
        analyticsContent.innerHTML =
          '<div class="analytics-loading">' +
            '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∑—ã–≤—ã</p>' +
          '</div>';
        return;
      }

      var ratingStatsHtml = '';
      if (analysis.rating_distribution) {
        ratingStatsHtml =
          '<div class="rating-stats">' +
            '<div class="card-title" style="margin-bottom: 10px;">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫</div>' +
            Object.entries(analysis.rating_distribution).map(function(entry) {
              var stars = entry[0];
              var count = entry[1];
              return '<div class="rating-stat-item">' +
                '<div class="rating-stars">' + createStars(parseInt(stars)) + '</div>' +
                '<div class="rating-count">' + count + ' –æ—Ç–∑—ã–≤–æ–≤</div>' +
              '</div>';
            }).join('') +
          '</div>';
      }

      function renderCategoryItems(items, prefix) {
        if (!items) return '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return items.map(function(item) {
          return '<div class="category-item" onclick="showReviewsForCategory(\\'' + prefix + '_' + item.name.replace(/'/g, "\\\\'") + '\\')">' +
            '<span class="category-name">' + item.name + '</span>' +
            '<span class="category-percentage">' + item.percentage + '%</span>' +
          '</div>';
        }).join('');
      }

      var genderMale = (analysis.gender_distribution && analysis.gender_distribution.male) || 0;
      var genderFemale = (analysis.gender_distribution && analysis.gender_distribution.female) || 0;

      var competitorHtml = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
      if (analysis.competitor_comparison) {
        competitorHtml = analysis.competitor_comparison.map(function(item) {
          var isBetter = item.name.includes('–ª—É—á—à–µ');
          var className = isBetter ? 'comparison-better' : 'comparison-worse';
          var displayName = item.name.replace(' - –ª—É—á—à–µ', '').replace(' - —Ö—É–∂–µ', '');
          return '<div class="category-item" onclick="showReviewsForCategory(\\'competitor_comparison_' + item.name.replace(/'/g, "\\\\'") + '\\')">' +
            '<span class="category-name">' + displayName + '</span>' +
            '<span class="category-percentage ' + className + '">' + item.percentage + '% ' + (isBetter ? 'üëç' : 'üëé') + '</span>' +
          '</div>';
        }).join('');
      }

      analyticsContent.innerHTML =
        '<div class="analytics-grid">' +
          '<div class="analytics-card">' +
            '<div class="card-title">–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</div>' +
            renderCategoryItems(analysis.usage, 'usage') +
          '</div>' +
          '<div class="analytics-card">' +
            '<div class="card-title">–î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞</div>' +
            renderCategoryItems(analysis.advantages, 'advantages') +
          '</div>' +
          '<div class="analytics-card">' +
            '<div class="card-title">–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏</div>' +
            renderCategoryItems(analysis.disadvantages, 'disadvantages') +
          '</div>' +
          '<div class="analytics-card">' +
            '<div class="card-title">–ü–æ–∫—É–ø–∞—Ç–µ–ª–∏</div>' +
            '<div class="gender-stats">' +
              '<div class="gender-item">' +
                '<div class="gender-icon gender-male">üë®</div>' +
                '<div class="gender-percentage">' + genderMale + '%</div>' +
                '<div class="gender-label">–ú—É–∂—á–∏–Ω—ã</div>' +
              '</div>' +
              '<div class="gender-item">' +
                '<div class="gender-icon gender-female">üë©</div>' +
                '<div class="gender-percentage">' + genderFemale + '%</div>' +
                '<div class="gender-label">–ñ–µ–Ω—â–∏–Ω—ã</div>' +
              '</div>' +
            '</div>' +
            ratingStatsHtml +
          '</div>' +
          '<div class="analytics-card">' +
            '<div class="card-title">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</div>' +
            renderCategoryItems(analysis.discovery_sources, 'discovery_sources') +
          '</div>' +
          '<div class="analytics-card">' +
            '<div class="card-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏</div>' +
            competitorHtml +
          '</div>' +
        '</div>';
    }

    function showReviewsForCategory(categoryKey) {
      var reviews = reviewCategories.get(categoryKey);

      if (!reviews || reviews.length === 0) {
        modalTitle.textContent = '–û—Ç–∑—ã–≤—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        modalReviews.innerHTML = '<p>–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>';
      } else {
        var categoryName = categoryKey.split('_').slice(1).join(' ');
        modalTitle.textContent = categoryName + ' - –æ—Ç–∑—ã–≤—ã';
        modalReviews.innerHTML = reviews.map(function(review) { return createReviewCard(review); }).join('');
      }

      reviewsModal.style.display = 'block';
    }

    function createReviewCard(review) {
      var productInfo = productsMap.get(review.sku.toString()) || {
        name: '–¢–æ–≤–∞—Ä ' + review.sku,
        image: null
      };
      
      let starsHtml = '';
      for (let i = 1; i <= 5; i++) {
        if (i <= review.rating) {
          starsHtml += '<span class="star">‚òÖ</span>';
        } else {
          starsHtml += '<span class="star" style="color: #ddd">‚òÖ</span>';
        }
      }
      
      const reviewDate = new Date(review.published_at);
      const formattedDate = reviewDate.toLocaleDateString('ru-RU');
      
      let statusClass = '';
      let statusText = '';
      
      switch(review.status) {
        case 'PUBLISHED':
          statusClass = 'status-published';
          statusText = '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω';
          break;
        case 'MODERATING':
          statusClass = 'status-unpublished';
          statusText = '–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏';
          break;
        case 'HIDDEN':
          statusClass = 'status-unpublished';
          statusText = '–°–∫—Ä—ã—Ç';
          break;
        default:
          statusClass = 'status-unpublished';
          statusText = review.status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      }
      
      var mediaHtml = '';
      if (review.photos_amount > 0 || review.videos_amount > 0 || review.comments_amount > 0) {
        mediaHtml = '<div class="media-count">';
        if (review.photos_amount > 0) {
          mediaHtml += '<div class="media-item">üì∑ ' + review.photos_amount + ' —Ñ–æ—Ç–æ</div>';
        }
        if (review.videos_amount > 0) {
          mediaHtml += '<div class="media-item">üé• ' + review.videos_amount + ' –≤–∏–¥–µ–æ</div>';
        }
        if (review.comments_amount > 0) {
          mediaHtml += '<div class="media-item">üí¨ ' + review.comments_amount + ' –∫–æ–º–º–µ–Ω—Ç.</div>';
        }
        mediaHtml += '</div>';
      }

      var productImageHtml = productInfo.image ?
        '<img src="' + productInfo.image + '" alt="' + productInfo.name + '" class="product-image">' :
        '<div class="product-image">–ù–µ—Ç —Ñ–æ—Ç–æ</div>';

      return '<div class="review-card">' +
          '<div class="product-info">' +
            productImageHtml +
            '<div class="product-name">' + productInfo.name + '</div>' +
          '</div>' +
          '<div class="rating">' +
            starsHtml +
            '<span style="margin-left: 10px; font-weight: bold;">' + review.rating + '/5</span>' +
          '</div>' +
          '<div class="review-text">' +
            review.text +
          '</div>' +
          mediaHtml +
          '<div class="review-meta">' +
            '<span>' + formattedDate + '</span>' +
            '<span class="status ' + statusClass + '">' + statusText + '</span>' +
          '</div>' +
        '</div>';
    }

    async function fetchProductsInfo() {
      const skus = [...new Set(allReviews.map(review => review.sku.toString()))];
      
      if (skus.length === 0) return;
      
      try {
        const skuBatches = [];
        for (let i = 0; i < skus.length; i += 100) {
          skuBatches.push(skus.slice(i, i + 100));
        }
        
        const credentials = { clientId: API_CONFIG.clientId, apiKey: API_CONFIG.apiKey };

        for (const skuBatch of skuBatches) {
          const requestBody = {
            sku: skuBatch
          };
          
          const response = await fetch(API_CONFIG.baseUrl + '/v3/product/info/list', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Client-Id': credentials.clientId,
              'Api-Key': credentials.apiKey
            },
            body: JSON.stringify(requestBody)
          });
          
          if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
          }
          
          const data = await response.json();
          
          if (data.result && data.result.items) {
            data.result.items.forEach(item => {
              productsMap.set(item.sku.toString(), {
                name: item.name || ('–¢–æ–≤–∞—Ä ' + item.sku),
                image: item.primary_image || (item.images && item.images.length > 0 ? item.images[0] : null)
              });
            });
          } else if (data.items) {
            data.items.forEach(item => {
              productsMap.set(item.sku.toString(), {
                name: item.name || ('–¢–æ–≤–∞—Ä ' + item.sku),
                image: item.primary_image || (item.images && item.images.length > 0 ? item.images[0] : null)
              });
            });
          } else {
            console.warn('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API —Ç–æ–≤–∞—Ä–æ–≤:', data);
          }
        }
        
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–≤–∞—Ä–∞—Ö:', error);
        const skus = [...new Set(allReviews.map(review => review.sku.toString()))];
        skus.forEach(sku => {
          if (!productsMap.has(sku)) {
            productsMap.set(sku, {
              name: '–¢–æ–≤–∞—Ä ' + sku,
              image: null
            });
          }
        });
      }
    }

    function populateProductSelect() {
      while (productSelect.children.length > 1) {
        productSelect.removeChild(productSelect.lastChild);
      }
      
      const uniqueSkus = [...new Set(allReviews.map(review => review.sku.toString()))];
      
      uniqueSkus.forEach(sku => {
        const product = productsMap.get(sku);
        const option = document.createElement('option');
        option.value = sku;
        option.textContent = product ? product.name : ('–¢–æ–≤–∞—Ä ' + sku);
        productSelect.appendChild(option);
      });
    }

    function downloadReviews() {
      if (!currentSelectedProduct) {
        showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç–∑—ã–≤–æ–≤');
        return;
      }
      
      const productReviews = allReviews.filter(review => 
        review.sku.toString() === currentSelectedProduct
      );
      
      if (productReviews.length === 0) {
        showError('–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞');
        return;
      }
      
      const productName = productsMap.get(currentSelectedProduct)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä';
      
      var fileContent = '–û—Ç–∑—ã–≤—ã –Ω–∞ —Ç–æ–≤–∞—Ä: ' + productName + '\\n';
      fileContent += '–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + new Date().toLocaleString('ru-RU') + '\\n';
      fileContent += '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤: ' + productReviews.length + '\\n\\n';
      fileContent += '='.repeat(50) + '\\n\\n';
      
      productReviews.forEach((review, index) => {
        fileContent += '–û—Ç–∑—ã–≤ ' + (index + 1) + ':\\n';
        fileContent += '–†–µ–π—Ç–∏–Ω–≥: ' + review.rating + '/5\\n';
        fileContent += '–î–∞—Ç–∞: ' + new Date(review.published_at).toLocaleDateString('ru-RU') + '\\n';
        fileContent += '–°—Ç–∞—Ç—É—Å: ' + getStatusText(review.status) + '\\n';
        fileContent += '–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞:\\n' + review.text + '\\n';

        if (review.photos_amount > 0 || review.videos_amount > 0) {
          fileContent += '–ú–µ–¥–∏–∞: ';
          if (review.photos_amount > 0) fileContent += 'üì∑ ' + review.photos_amount + ' —Ñ–æ—Ç–æ ';
          if (review.videos_amount > 0) fileContent += 'üé• ' + review.videos_amount + ' –≤–∏–¥–µ–æ';
          fileContent += '\\n';
        }
        
        fileContent += '\\n' + '='.repeat(50) + '\\n\\n';
      });
      
      const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '–æ—Ç–∑—ã–≤—ã_' + productName.replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function getStatusText(status) {
      switch(status) {
        case 'PUBLISHED': return '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω';
        case 'MODERATING': return '–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏';
        case 'HIDDEN': return '–°–∫—Ä—ã—Ç';
        default: return status;
      }
    }

    function displayReviews(reviews) {
      reviewsContainer.innerHTML = '';
      
      if (reviews.length === 0) {
        reviewsContainer.innerHTML = '<div class="no-reviews">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
        return;
      }
      
      reviews.forEach(review => {
        const reviewCard = document.createElement('div');
        reviewCard.innerHTML = createReviewCard(review);
        reviewsContainer.appendChild(reviewCard);
      });
    }

    function showLoading() {
      reviewsContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...</div>';
    }

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      
      setTimeout(() => {
        successMessage.style.display = 'none';
      }, 5000);
    }

    function showInfo(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      successMessage.style.backgroundColor = '#e7f3ff';
      successMessage.style.color = '#0066cc';
    }

    window.showReviewsForCategory = showReviewsForCategory;
  </script>
` }) %>

