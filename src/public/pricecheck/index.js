(()=>{var{useState:H,useEffect:ze,useMemo:ue,useRef:le}=React,{createRoot:yt}=ReactDOM,$e=window.Chart,Ve="https://lkk.smazka.ru/apiv1/get/pps?token=gulldl9yR7XKWadO1L64&t=actual&pc=0&cm=8";var pe=[{name:"account1",client_id:"106736",api_key:"5cf6e47b-0f73-4b23-b8cd-6a097e7cd60d"},{name:"account2",client_id:"224361",api_key:"7ac7cd44-9acf-47b5-b7ca-30de0a46f5d0"},{name:"account3",client_id:"224458",api_key:"7e634373-5841-4eaf-9cef-b5afebe888ac"}],oe="/pricecheck/api",te="price_regulator_data",we=t=>{if(!t)return 0;let f=t.replace(/[^\d.,]/g,"").replace(/,/g,".").replace(/\s+/g,""),v=parseFloat(f);return isNaN(v)?0:v};var ge=t=>{if(!t)return null;try{let v=new URL(t).pathname.split("/"),C=v.indexOf("product");if(C!==-1&&v[C+1])return v[C+1];let T=v[v.length-1].match(/\d+/);return T?T[0]:null}catch{let v=t.match(/product\/(\d+)/);return v?v[1]:null}};var Y=t=>{if(!t||t.length===0)return console.error("\u274C \u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u0430\u043D\u0430\u043B\u0438\u0437\u0430"),{name:-1,brand:-1,link:-1,qty:-1,sum:-1};let f=-1,v=[];for(let U=0;U<t.length;U++){let _=t[U];if(!Array.isArray(_)||_.length===0)continue;let B=_.map(R=>String(R).toLowerCase().replace(/\s+/g," ").trim()),M=B.some(R=>R.includes("\u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430")||R.includes("\u043D\u0430\u0438\u043C\u0435\u043D\u043E\u0432\u0430\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430")),F=B.some(R=>R.includes("\u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0442\u043E\u0432\u0430\u0440")||R.includes("\u0441\u0441\u044B\u043B\u043A\u0430")),q=B.some(R=>R.includes("\u0431\u0440\u0435\u043D\u0434")||R.includes("\u043F\u0440\u043E\u0434\u0430\u0432\u0435\u0446")),ce=B.some(R=>R.includes("\u0437\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442\u0443\u043A\u0438")||R.includes("\u0448\u0442\u0443\u043A\u0438")),A=B.some(R=>R.includes("\u0437\u0430\u043A\u0430\u0437\u0430\u043D\u043E \u043D\u0430 \u0441\u0443\u043C\u043C\u0443")||R.includes("\u0441\u0443\u043C\u043C\u0430, \u20BD"));if(M&&F&&q&&ce&&A){f=U,v=_,console.log(`\u2705 \u041D\u0430\u0439\u0434\u0435\u043D\u0430 \u0441\u0442\u0440\u043E\u043A\u0430 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u043E\u0432 \u043D\u0430 \u0441\u0442\u0440\u043E\u043A\u0435 ${U+1}:`,B);break}}f===-1&&(console.error("\u274C \u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 \u0441\u0442\u0440\u043E\u043A\u0430 \u0441 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u0430\u043C\u0438 \u0442\u0430\u0431\u043B\u0438\u0446\u044B"),v=t[0]||[],console.log("\u26A0\uFE0F \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C \u043F\u0435\u0440\u0432\u0443\u044E \u0441\u0442\u0440\u043E\u043A\u0443 \u043A\u0430\u043A \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u0438:",v));let C=v.map(U=>String(U).toLowerCase().replace(/\s+/g," ").trim());console.log("\u{1F50D} \u0418\u0449\u0435\u043C \u043A\u043E\u043B\u043E\u043D\u043A\u0438 \u043F\u043E \u0442\u043E\u0447\u043D\u044B\u043C \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F\u043C \u0432:",C);let z=U=>{for(let _=0;_<C.length;_++){let B=C[_];for(let M of U)if(B===M)return console.log(`\u2705 \u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0442\u043E\u0447\u043D\u043E\u0435 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0435: "${B}" = "${M}" \u043D\u0430 \u0438\u043D\u0434\u0435\u043A\u0441\u0435 ${_}`),_}return-1},T=z(["\u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430"]),X=z(["\u0441\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0442\u043E\u0432\u0430\u0440"]),I=z(["\u0431\u0440\u0435\u043D\u0434"]);I===-1&&(I=z(["\u043F\u0440\u043E\u0434\u0430\u0432\u0435\u0446"]));let L=z(["\u0437\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442\u0443\u043A\u0438"]),W=z(["\u0437\u0430\u043A\u0430\u0437\u0430\u043D\u043E \u043D\u0430 \u0441\u0443\u043C\u043C\u0443, \u20BD"]);console.log("\u{1F4CA} \u041D\u0430\u0439\u0434\u0435\u043D\u043D\u044B\u0435 \u0438\u043D\u0434\u0435\u043A\u0441\u044B:",{nameIdx:T,brandIdx:I,linkIdx:X,qtyIdx:L,sumIdx:W});let $=[];return T===-1&&$.push("\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430"),X===-1&&$.push("\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0442\u043E\u0432\u0430\u0440"),I===-1&&$.push("\u0411\u0440\u0435\u043D\u0434 \u0438\u043B\u0438 \u041F\u0440\u043E\u0434\u0430\u0432\u0435\u0446"),L===-1&&$.push("\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442\u0443\u043A\u0438"),W===-1&&$.push("\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E \u043D\u0430 \u0441\u0443\u043C\u043C\u0443, \u20BD"),$.length>0?(console.error("\u274C \u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B \u043A\u043E\u043B\u043E\u043D\u043A\u0438:",$),console.log("\u2139\uFE0F \u0412\u0441\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u0438:",C),{name:-1,brand:-1,link:-1,qty:-1,sum:-1}):(console.log("\u2705 \u0412\u0441\u0435 \u043A\u043E\u043B\u043E\u043D\u043A\u0438 \u043D\u0430\u0439\u0434\u0435\u043D\u044B!"),console.log("\u{1F4CB} \u0424\u0430\u043A\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u0438:",{name:v[T],link:v[X],brand:v[I],qty:v[L],sum:v[W]}),{name:T,brand:I,link:X,qty:L,sum:W})},ee=async(t,f=te)=>{try{let v={competitorSelections:t.competitorSelections||{},uploadedFiles:t.uploadedFiles||{},parsedPrices:t.parsedPrices||{},lastUpdated:new Date().toISOString()};console.log("\u{1F4BE} \u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 \u0434\u0430\u043D\u043D\u044B\u0445 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440:",{competitors:Object.keys(v.competitorSelections).length,files:Object.keys(v.uploadedFiles).length,size:JSON.stringify(v).length/1024+" KB"});let C=await fetch(`${oe}/data/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:f,data:v})});if(!C.ok){let z=await C.text();throw new Error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430: ${C.status} - ${z}`)}return await C.json()}catch(v){throw console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0434\u0430\u043D\u043D\u044B\u0445 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440:",v),v}},Ce=async(t=te)=>{try{let f=await fetch(`${oe}/data/load/${t}`);if(!f.ok){if(f.status===404)return{success:!1,data:null,message:"\u0424\u0430\u0439\u043B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"};let v=await f.text();throw new Error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430: ${f.status} - ${v}`)}return await f.json()}catch(f){throw console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0434\u0430\u043D\u043D\u044B\u0445 \u0441 \u0441\u0435\u0440\u0432\u0435\u0440\u0430:",f),f}},ft=async()=>{try{let t=await fetch(`${oe}/data/files`);if(!t.ok){let f=await t.text();throw new Error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430: ${t.status} - ${f}`)}return await t.json()}catch(t){throw console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0441\u043F\u0438\u0441\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432:",t),t}},wt=async t=>{try{let f=await fetch(`${oe}/data/delete/${t}`,{method:"DELETE"});if(!f.ok){let v=await f.text();throw new Error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430: ${f.status} - ${v}`)}return await f.json()}catch(f){throw console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0444\u0430\u0439\u043B\u0430:",f),f}},vt=async()=>{try{let t=await fetch(`${oe}/data/backup`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok){let f=await t.text();throw new Error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430: ${t.status} - ${f}`)}return await t.json()}catch(t){throw console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F \u0431\u044D\u043A\u0430\u043F\u0430:",t),t}},ae=(t,f)=>{let v=Object.keys(t).sort().reverse();for(let C of v)if(t[C]?.[f])return{price:t[C][f],date:C};return null},_e=t=>Object.keys(t).some(f=>t[f]&&Object.keys(t[f]).length>0),Nt=({priceHistory:t})=>{let f=le(null),v=le(null),C=le(null),z=le(null),T=le(null),X=le(null);return ze(()=>{if(!f.current||!v.current||!C.current||t.length<2)return;let I=[...t].sort((F,q)=>new Date(F.date).getTime()-new Date(q.date).getTime()),L=I.map(F=>new Date(F.date).toLocaleDateString("ru-RU")),W=I.map(F=>F.priceNumber||0),$=I.map(F=>F.qtyNumber!==void 0&&F.qtyNumber!==null?F.qtyNumber:0),U=I.map(F=>F.sumNumber!==void 0&&F.sumNumber!==null?F.sumNumber:0);z.current&&z.current.destroy(),T.current&&T.current.destroy(),X.current&&X.current.destroy();let _=f.current.getContext("2d");_&&(z.current=new $e(_,{type:"line",data:{labels:L,datasets:[{label:"\u0426\u0435\u043D\u0430 \u043F\u043E Ozon Card (\u20BD)",data:W,borderColor:"rgb(75, 192, 192)",backgroundColor:"rgba(75, 192, 192, 0.2)",tension:.3,fill:!0,pointRadius:4,pointHoverRadius:6}]},options:{responsive:!0,plugins:{title:{display:!0,text:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0446\u0435\u043D",font:{size:16,weight:"bold"},color:"#333"},legend:{display:!0,position:"top",labels:{font:{size:12}}},tooltip:{callbacks:{label:function(F){return`\u0426\u0435\u043D\u0430: ${I[F.dataIndex].price||"\u043D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445"}`}}}},scales:{x:{display:!0,title:{display:!0,text:"\u0414\u0430\u0442\u0430",font:{weight:"bold"}},ticks:{maxRotation:45,minRotation:45}},y:{display:!0,title:{display:!0,text:"\u0426\u0435\u043D\u0430 (\u20BD)",font:{weight:"bold"}},beginAtZero:!1}},interaction:{intersect:!1,mode:"index"}}}));let B=v.current.getContext("2d");if(B){let F=$.some(q=>q>0);T.current=new $e(B,{type:"bar",data:{labels:L,datasets:[{label:"\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442\u0443\u043A\u0438",data:$,backgroundColor:"rgba(255, 99, 132, 0.6)",borderColor:"rgb(255, 99, 132)",borderWidth:1}]},options:{responsive:!0,plugins:{title:{display:!0,text:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u0430 \u0437\u0430\u043A\u0430\u0437\u043E\u0432",font:{size:16,weight:"bold"},color:"#333"},legend:{display:!0,position:"top",labels:{font:{size:12}}},tooltip:{callbacks:{label:function(q){return`\u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E: ${I[q.dataIndex].qty||"0"} \u0448\u0442`}}}},scales:{x:{display:!0,title:{display:!0,text:"\u0414\u0430\u0442\u0430",font:{weight:"bold"}},ticks:{maxRotation:45,minRotation:45}},y:{display:!0,title:{display:!0,text:"\u041A\u043E\u043B\u0438\u0447\u0435\u0441\u0442\u0432\u043E (\u0448\u0442)",font:{weight:"bold"}},beginAtZero:!0}}}})}let M=C.current.getContext("2d");if(M){let F=U.some(q=>q>0);X.current=new $e(M,{type:"bar",data:{labels:L,datasets:[{label:"\u0421\u0443\u043C\u043C\u0430 \u0437\u0430\u043A\u0430\u0437\u0430 (\u20BD)",data:U,backgroundColor:"rgba(54, 162, 235, 0.6)",borderColor:"rgb(54, 162, 235)",borderWidth:1}]},options:{responsive:!0,plugins:{title:{display:!0,text:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0443\u043C\u043C\u044B \u0437\u0430\u043A\u0430\u0437\u043E\u0432",font:{size:16,weight:"bold"},color:"#333"},legend:{display:!0,position:"top",labels:{font:{size:12}}},tooltip:{callbacks:{label:function(q){return`\u0421\u0443\u043C\u043C\u0430: ${I[q.dataIndex].sum||"0"} \u20BD`}}}},scales:{x:{display:!0,title:{display:!0,text:"\u0414\u0430\u0442\u0430",font:{weight:"bold"}},ticks:{maxRotation:45,minRotation:45}},y:{display:!0,title:{display:!0,text:"\u0421\u0443\u043C\u043C\u0430 (\u20BD)",font:{weight:"bold"}},beginAtZero:!0,ticks:{callback:function(q){return`${q} \u20BD`}}}}}})}return()=>{z.current&&z.current.destroy(),T.current&&T.current.destroy(),X.current&&X.current.destroy()}},[t]),t.length<2?React.createElement("div",{className:"text-center text-muted py-4"},React.createElement("i",{className:"bi bi-bar-chart fs-1 mb-3 d-block"}),React.createElement("p",null,"\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u043F\u043E\u0441\u0442\u0440\u043E\u0435\u043D\u0438\u044F \u0433\u0440\u0430\u0444\u0438\u043A\u043E\u0432 (\u043D\u0443\u0436\u043D\u043E \u043C\u0438\u043D\u0438\u043C\u0443\u043C 2 \u0437\u0430\u043F\u0438\u0441\u0438)")):React.createElement("div",{className:"history-chart-container"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-12 mb-4"},React.createElement("div",{className:"card"},React.createElement("div",{className:"card-body"},React.createElement("div",{style:{position:"relative",height:"300px",width:"100%"}},React.createElement("canvas",{ref:f}))))),React.createElement("div",{className:"col-md-6 mb-4"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-body"},React.createElement("div",{style:{position:"relative",height:"250px",width:"100%"}},React.createElement("canvas",{ref:v}))))),React.createElement("div",{className:"col-md-6 mb-4"},React.createElement("div",{className:"card h-100"},React.createElement("div",{className:"card-body"},React.createElement("div",{style:{position:"relative",height:"250px",width:"100%"}},React.createElement("canvas",{ref:C})))))))},St=()=>{let[t,f]=H({vmpData:[],ozonData:{},ozonPrices:{},loading:!0,error:null,selectedType:null,uploadedFiles:{},usingFallback:!1,competitorSelections:{},activeModalSku:null,isParsingPrices:!1,parsedPrices:{},searchTerm:"",filteredRows:null,expandedProducts:{},salesData:{},salesLoading:!1,ozonCategories:{},collapsedCategories:{}}),[v,C]=H(null),[z,T]=H(new Set),[X,I]=H({current:0,total:0,status:""}),[L,W]=H(null),[$,U]=H(null),[_,B]=H(null),[M,F]=H({current:0,total:0,stage:""}),[q,ce]=H([]),[A,R]=H(te),[Fe,Ke]=H(!1),[ve,Ie]=H(!1),[Z,Ne]=H({competitor:null,productName:""});ze(()=>{He(),de();let e=setInterval(()=>{Oe()},5*60*1e3);return()=>{clearInterval(e)}},[]),ze(()=>{if((Object.keys(t.competitorSelections).length>0||Object.keys(t.uploadedFiles).length>0)&&!ve){let s=setTimeout(()=>{Oe()},2e3);return()=>clearTimeout(s)}},[t.competitorSelections,t.uploadedFiles,A]);let He=async()=>{try{console.log("\u{1F504} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0434\u0430\u043D\u043D\u044B\u0445...");let e=[],s=!1;try{console.log("\u{1F310} \u0417\u0430\u043F\u0440\u043E\u0441 \u043A:",Ve);let c=await fetch(Ve,{method:"GET",headers:{Accept:"application/json"}});if(console.log("\u{1F4CA} \u0421\u0442\u0430\u0442\u0443\u0441:",c.status,"OK:",c.ok),!c.ok){let w=await c.text();throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 API:",w),new Error(`VMP API Error: ${c.status}`)}let g=await c.text();console.log("\u{1F4E6} \u0421\u044B\u0440\u043E\u0439 \u043E\u0442\u0432\u0435\u0442 (\u043F\u0435\u0440\u0432\u044B\u0435 500 \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432):",g.substring(0,500));let y;try{y=JSON.parse(g),console.log("\u2705 JSON \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0440\u0430\u0441\u043F\u0430\u0440\u0441\u0435\u043D:",typeof y)}catch(w){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 JSON:",w.message),new Error("Invalid JSON response")}Array.isArray(y)?(e=y,console.log(`\u2705 \u041F\u043E\u043B\u0443\u0447\u0435\u043D \u043C\u0430\u0441\u0441\u0438\u0432 \u0438\u0437 ${e.length} \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u043E\u0432`)):(console.warn("\u26A0\uFE0F \u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u0430\u044F \u0441\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430 \u043E\u0442\u0432\u0435\u0442\u0430:",y),e=[])}catch(c){console.warn("\u274C API Fetch failed:",c.message);try{console.log("\u{1F504} \u041F\u0440\u043E\u0431\u0443\u0435\u043C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C fallback \u0434\u0430\u043D\u043D\u044B\u0435...");let g=await fetch("./data_cache.json");if(!g.ok)throw new Error("Could not load local cache file");e=(await g.json()).data||[],s=!0,console.log(`\u2705 \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C fallback: ${e.length} \u044D\u043B\u0435\u043C\u0435\u043D\u0442\u043E\u0432`)}catch(g){throw console.error("\u{1F4A5} Fallback \u0442\u043E\u0436\u0435 \u043D\u0435 \u0441\u0440\u0430\u0431\u043E\u0442\u0430\u043B:",g),new Error("Failed to load data from any source.")}}e.length===0?console.warn("\u26A0\uFE0F \u041F\u043E\u043B\u0443\u0447\u0435\u043D \u043F\u0443\u0441\u0442\u043E\u0439 \u043C\u0430\u0441\u0441\u0438\u0432 \u0442\u043E\u0432\u0430\u0440\u043E\u0432"):console.log(`\u{1F389} \u0423\u0441\u043F\u0435\u0448\u043D\u043E \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E: ${e.length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`);let o={};e.forEach(c=>{c.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430&&(o[c.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430]=(o[c.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430]||0)+1)});let a=Object.entries(o).sort((c,g)=>g[1]-c[1]),r=a.length>0?a[0][0]:null;console.log("\u{1F3F7}\uFE0F \u0414\u043E\u0441\u0442\u0443\u043F\u043D\u044B\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438:",a);let n=Array.from(new Set(e.map(c=>c.\u0410\u0440\u0442\u0438\u043A\u0443\u043B).filter(Boolean))),i={},d={};console.log("\u{1F680} \u041F\u0430\u0440\u0430\u043B\u043B\u0435\u043B\u044C\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0434\u0430\u043D\u043D\u044B\u0445...");let[u,l]=await Promise.allSettled([(async()=>{console.log("\u{1F6D2} \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C Ozon \u0434\u0430\u043D\u043D\u044B\u0435...");let c=await Xe(n);return console.log(`\u2705 Ozon \u0434\u0430\u043D\u043D\u044B\u0445: ${Object.keys(c).length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`),c})(),(async()=>{console.log("\u{1F4CA} \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0434\u0430\u043D\u043D\u044B\u0435 \u043E \u043F\u0440\u043E\u0434\u0430\u0436\u0430\u0445 \u0437\u0430 \u043D\u0435\u0434\u0435\u043B\u044E...");let c=await Je();return console.log(`\u2705 \u0414\u0430\u043D\u043D\u044B\u0445 \u043E \u043F\u0440\u043E\u0434\u0430\u0436\u0430\u0445: ${Object.keys(c).length} SKU`),c})()]);i=u.status==="fulfilled"?u.value:{},u.status==="rejected"&&console.warn("Ozon API fetch failed",u.reason);let m=l.status==="fulfilled"?l.value:{};l.status==="rejected"&&console.warn("Sales API fetch failed",l.reason);try{console.log("\u{1F4B0} \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0434\u0430\u043D\u043D\u044B\u0435 \u043E \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442\u0435..."),d=await Qe(n,i),console.log(`\u2705 \u0414\u0430\u043D\u043D\u044B\u0445 \u043E \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442\u0435: ${Object.keys(d).length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`)}catch(c){console.warn("Ozon prices API fetch failed",c)}let p={};try{let c=Array.from(new Set(Object.values(i).map(g=>g.type_id).filter(g=>g!==void 0&&g>0)));c.length>0&&(console.log("\u{1F4C1} \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F \u0442\u0438\u043F\u043E\u0432 \u0442\u043E\u0432\u0430\u0440\u043E\u0432..."),p=await We(c))}catch(c){console.warn("Ozon categories fetch failed",c)}f(c=>({...c,vmpData:e,ozonData:i,ozonPrices:d,salesData:m,ozonCategories:p,loading:!1,usingFallback:s,selectedType:r})),console.log("\u{1F680} \u041F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u0433\u043E\u0442\u043E\u0432\u043E!")}catch(e){console.error("\u{1F4A5} \u041A\u0440\u0438\u0442\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430:",e),f(s=>({...s,loading:!1,error:`\u041E\u0448\u0438\u0431\u043A\u0430: ${e.message}`}))}},We=async e=>{let s={};if(e.length===0)return s;console.log("\u{1F4C1} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0439 \u0442\u0438\u043F\u043E\u0432 \u0442\u043E\u0432\u0430\u0440\u043E\u0432 Ozon \u0434\u043B\u044F",e.length,"ID:",e);let o=pe[0];try{let a=await fetch("https://api-seller.ozon.ru/v1/description-category/tree",{method:"POST",headers:{"Content-Type":"application/json","Client-Id":o.client_id,"Api-Key":o.api_key},body:JSON.stringify({language:"RU"})});if(a.ok){let r=await a.json();console.log("\u{1F4C1} \u041E\u0442\u0432\u0435\u0442 \u043E\u0442 description-category/tree \u043F\u043E\u043B\u0443\u0447\u0435\u043D");let n=d=>{d.children&&Array.isArray(d.children)&&d.children.forEach(u=>{if(u.type_id&&e.includes(u.type_id)){let l=u.type_name||u.category_name||u.title;l&&(s[u.type_id]=l,console.log(`\u{1F4C1} \u041D\u0430\u0439\u0434\u0435\u043D \u0442\u0438\u043F \u0442\u043E\u0432\u0430\u0440\u0430: ${u.type_id} = "${l}"`))}u.description_category_id&&n(u)})},i=r.result||[];Array.isArray(i)&&i.forEach(d=>n(d)),console.log(`\u2705 \u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0439 \u0442\u0438\u043F\u043E\u0432: ${Object.keys(s).length} \u0438\u0437 ${e.length}`)}else{let r=await a.text();console.warn(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439: ${a.status}`,r.substring(0,200))}}catch(a){console.warn("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u043F\u0440\u043E\u0441\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439:",a.message)}return s},Xe=async e=>{let o={};if(console.log("\u{1F6D2} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 Ozon \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u0430\u0440\u0442\u0438\u043A\u0443\u043B\u043E\u0432:",e.length),e.length===0)return console.log("\u26A0\uFE0F \u041D\u0435\u0442 \u0430\u0440\u0442\u0438\u043A\u0443\u043B\u043E\u0432 \u0434\u043B\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 Ozon \u0434\u0430\u043D\u043D\u044B\u0445"),o;let a=[];for(let n=0;n<e.length;n+=50)a.push(e.slice(n,n+50));console.log(`\u{1F4E6} \u0420\u0430\u0437\u0434\u0435\u043B\u0438\u043B\u0438 \u043D\u0430 ${a.length} \u0447\u0430\u043D\u043A\u043E\u0432 \u043F\u043E 50 \u0430\u0440\u0442\u0438\u043A\u0443\u043B\u043E\u0432`);let r=[];for(let n=0;n<a.length;n++){let i=a[n];F({current:n+1,total:a.length,stage:"\u041F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u0435 \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u0438 \u043E \u0442\u043E\u0432\u0430\u0440\u0430\u0445"}),console.log(`
\u{1F4CA} \u0427\u0430\u043D\u043A ${n+1}/${a.length}: \u041F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u0435 \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u0438 \u043E \u0442\u043E\u0432\u0430\u0440\u0430\u0445`);let d=[...i];for(let u of pe){if(d.length===0)break;console.log(`\u{1F510} \u0410\u043A\u043A\u0430\u0443\u043D\u0442: ${u.name}, \u043E\u0441\u0442\u0430\u043B\u043E\u0441\u044C: ${d.length}`);try{let l=await fetch("https://api-seller.ozon.ru/v3/product/info/list",{method:"POST",headers:{"Content-Type":"application/json","Client-Id":u.client_id,"Api-Key":u.api_key},body:JSON.stringify({offer_id:d})});if(console.log(`\u{1F4E1} \u0421\u0442\u0430\u0442\u0443\u0441 \u043E\u0442\u0432\u0435\u0442\u0430 v3/product/info/list: ${l.status}`),l.ok){let m=await l.json();console.log(`\u{1F4E6} \u041E\u0442\u0432\u0435\u0442 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u0442: ${m.items?.length||0} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`),m.items&&Array.isArray(m.items)&&m.items.forEach(p=>{p.is_archived||(r.push({offer_id:p.offer_id,sku:p.sku,price:p.price,primary_image:Array.isArray(p.primary_image)?p.primary_image[0]:p.primary_image,images:p.images,is_archived:p.is_archived,description_category_id:p.description_category_id,type_id:p.type_id}),d=d.filter(c=>c!==p.offer_id),console.log(`\u2705 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0442\u043E\u0432\u0430\u0440: ${p.offer_id}, SKU: ${p.sku}, \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F: ${p.description_category_id}, \u0442\u0438\u043F: ${p.type_id}`))})}else{let m=await l.text();console.warn(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 API v3/product/info/list: ${l.status}`,m.substring(0,200))}}catch(l){console.warn(`\u274C \u0421\u0435\u0442\u0435\u0432\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430 \u0434\u043B\u044F \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430 ${u.name}:`,l.message)}await new Promise(l=>setTimeout(l,100))}console.log(`\u2705 \u0427\u0430\u043D\u043A ${n+1} \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D, \u043D\u0430\u0439\u0434\u0435\u043D\u043E \u0442\u043E\u0432\u0430\u0440\u043E\u0432: ${r.length}`)}if(r.length>0){console.log(`
\u{1F4B0} \u041F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u0435 \u0446\u0435\u043D \u043F\u043E Ozon Card \u0434\u043B\u044F ${r.length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`);let n=r.filter(l=>l.sku&&l.sku>0).map(l=>l.sku.toString());console.log(`\u{1F522} \u041D\u0430\u0439\u0434\u0435\u043D\u043E SKU: ${n.length}`);let i=100,d=[];for(let l=0;l<n.length;l+=i)d.push(n.slice(l,l+i));console.log(`\u{1F4CA} \u0420\u0430\u0437\u0434\u0435\u043B\u0438\u043B\u0438 SKU \u043D\u0430 ${d.length} \u0447\u0430\u043D\u043A\u043E\u0432 \u0434\u043B\u044F \u0437\u0430\u043F\u0440\u043E\u0441\u0430 \u0446\u0435\u043D`);let u={};for(let l=0;l<d.length;l++){let m=d[l];F({current:l+1,total:d.length,stage:"\u041F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u0435 \u0446\u0435\u043D \u043F\u043E Ozon Card"}),console.log(`
\u{1F4B3} \u0427\u0430\u043D\u043A ${l+1}/${d.length}: \u0417\u0430\u043F\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u043C \u0446\u0435\u043D\u044B \u0434\u043B\u044F ${m.length} SKU`);let p=[...m];for(let c of pe){if(p.length===0)break;console.log(`\u{1F510} \u0410\u043A\u043A\u0430\u0443\u043D\u0442 \u0434\u043B\u044F \u0446\u0435\u043D: ${c.name}, \u043E\u0441\u0442\u0430\u043B\u043E\u0441\u044C SKU: ${p.length}`);try{let g=await fetch("https://api-seller.ozon.ru/v1/product/prices/details",{method:"POST",headers:{"Content-Type":"application/json","Client-Id":c.client_id,"Api-Key":c.api_key},body:JSON.stringify({skus:p})});if(console.log(`\u{1F4E1} \u0421\u0442\u0430\u0442\u0443\u0441 \u043E\u0442\u0432\u0435\u0442\u0430 v1/product/prices/details: ${g.status}`),g.ok){let y=await g.json();console.log(`\u{1F4B0} \u0410\u043A\u043A\u0430\u0443\u043D\u0442 ${c.name}: \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u043E ${y.prices?.length||0} \u0446\u0435\u043D`),y.prices&&Array.isArray(y.prices)&&y.prices.forEach(w=>{u[w.sku.toString()]||(u[w.sku.toString()]=w,p=p.filter(S=>S!==w.sku.toString()),console.log(`\u2705 \u0426\u0435\u043D\u0430 \u043E\u0442 ${c.name} \u0434\u043B\u044F SKU ${w.sku}: ${w.customer_price.amount} ${w.customer_price.currency}`))})}else{let y=await g.text();console.warn(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 API v1/product/prices/details \u0443 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430 ${c.name}: ${g.status}`,y.substring(0,200))}}catch(g){console.warn(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0446\u0435\u043D \u043E\u0442 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430 ${c.name}:`,g.message)}await new Promise(g=>setTimeout(g,150))}console.log(`\u2705 \u0427\u0430\u043D\u043A ${l+1} \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D, \u043D\u0430\u0439\u0434\u0435\u043D\u043E \u0446\u0435\u043D: ${Object.keys(u).length}`)}console.log(`
\u{1F517} \u041E\u0431\u044A\u0435\u0434\u0438\u043D\u044F\u0435\u043C \u0434\u0430\u043D\u043D\u044B\u0435 \u043E \u0442\u043E\u0432\u0430\u0440\u0430\u0445 \u0438 \u0446\u0435\u043D\u0430\u0445...`),r.forEach(l=>{if(l.sku&&u[l.sku.toString()]){let m=u[l.sku.toString()];o[l.offer_id]={offer_id:l.offer_id,sku:l.sku,price:l.price||"0",customer_price:`${m.customer_price.amount} ${m.customer_price.currency}`,primary_image:l.primary_image,images:l.images,is_archived:l.is_archived,description_category_id:l.description_category_id,type_id:l.type_id},console.log(`\u{1F3AF} ${l.offer_id}: \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F: ${l.description_category_id}, \u0442\u0438\u043F: ${l.type_id}`)}else l.price&&(o[l.offer_id]={offer_id:l.offer_id,sku:l.sku,price:l.price,customer_price:void 0,primary_image:l.primary_image,images:l.images,is_archived:l.is_archived,description_category_id:l.description_category_id,type_id:l.type_id},console.log(`\u26A0\uFE0F ${l.offer_id}: \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F: ${l.description_category_id}, \u0442\u0438\u043F: ${l.type_id}`))})}else console.log("\u26A0\uFE0F \u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0434\u043B\u044F \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0446\u0435\u043D");return console.log(`
\u{1F389} \u0418\u0442\u043E\u0433: \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E ${Object.keys(o).length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0441 \u0446\u0435\u043D\u0430\u043C\u0438`),F({current:0,total:0,stage:""}),o},Qe=async(e,s)=>{let o={};if(console.log("\u{1F4B0} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0446\u0435\u043D \u0438 \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u0442\u043E\u0432\u0430\u0440\u043E\u0432:",e.length),e.length===0)return console.log("\u26A0\uFE0F \u041D\u0435\u0442 \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0434\u043B\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0446\u0435\u043D"),o;let a=[],r={};if(e.forEach(u=>{let l=s[u];if(l&&l.sku){let m=l.sku.toString();a.push(m),r[m]=u,console.log(`\u{1F517} \u041C\u0430\u043F\u043F\u0438\u043D\u0433: SKU ${m} -> offer_id ${u}`)}else console.log(`\u26A0\uFE0F \u0423 \u0442\u043E\u0432\u0430\u0440\u0430 ${u} \u043D\u0435\u0442 SKU \u0438\u043B\u0438 \u0434\u0430\u043D\u043D\u044B\u0445 \u0432 ozonData`)}),a.length===0)return console.log("\u26A0\uFE0F \u041D\u0435\u0442 SKU \u0434\u043B\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442\u0430"),o;console.log(`\u{1F522} \u041D\u0430\u0439\u0434\u0435\u043D\u043E SKU: ${a.length} \u0438\u0437 ${e.length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`),console.log("\u{1F4CB} \u041C\u0430\u043F\u043F\u0438\u043D\u0433 SKU->offer_id:",r);let n=100,i=[];for(let u=0;u<a.length;u+=n)i.push(a.slice(u,u+n));console.log(`\u{1F4E6} \u0420\u0430\u0437\u0434\u0435\u043B\u0438\u043B\u0438 \u043D\u0430 ${i.length} \u0447\u0430\u043D\u043A\u043E\u0432 \u043F\u043E ${n} SKU`);for(let u=0;u<i.length;u++){let l=i[u];console.log(`
\u{1F4B3} \u0427\u0430\u043D\u043A ${u+1}/${i.length}: \u0417\u0430\u043F\u0440\u0430\u0448\u0438\u0432\u0430\u0435\u043C \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442 \u0434\u043B\u044F ${l.length} SKU`);let m=[...l];for(let p of pe){if(m.length===0)break;console.log(`\u{1F510} \u0410\u043A\u043A\u0430\u0443\u043D\u0442 \u0434\u043B\u044F \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442\u0430: ${p.name}, \u043E\u0441\u0442\u0430\u043B\u043E\u0441\u044C SKU: ${m.length}`);try{let c=await fetch("https://api-seller.ozon.ru/v1/product/prices/details",{method:"POST",headers:{"Content-Type":"application/json","Client-Id":p.client_id,"Api-Key":p.api_key},body:JSON.stringify({skus:m})});if(console.log(`\u{1F4E1} \u0421\u0442\u0430\u0442\u0443\u0441 \u043E\u0442\u0432\u0435\u0442\u0430 v1/product/prices/details: ${c.status}`),c.ok){let g=await c.json();console.log(`\u{1F4B0} \u0410\u043A\u043A\u0430\u0443\u043D\u0442 ${p.name}: \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u043E ${g.prices?.length||0} \u0446\u0435\u043D \u0441 \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442\u043E\u043C`),g.prices&&Array.isArray(g.prices)&&g.prices.forEach(y=>{let w=y.sku.toString();o[w]||(o[w]=y,m=m.filter(S=>S!==w),console.log(`\u2705 \u0421\u043E\u0438\u043D\u0432\u0435\u0441\u0442 \u043E\u0442 ${p.name} \u0434\u043B\u044F SKU ${w}: ${y.discount_percent}`))})}else{let g=await c.text();console.warn(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 API v1/product/prices/details \u0443 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430 ${p.name}: ${c.status}`,g.substring(0,200))}}catch(c){console.warn(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442\u0430 \u043E\u0442 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430 ${p.name}:`,c.message)}await new Promise(c=>setTimeout(c,1e3))}console.log(`\u2705 \u0427\u0430\u043D\u043A ${u+1} \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D, \u043D\u0430\u0439\u0434\u0435\u043D\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439: ${Object.keys(o).length}`)}let d={};return Object.entries(o).forEach(([u,l])=>{let m=r[u];m?(d[m]=l,console.log(`\u{1F517} \u0421\u0432\u044F\u0437\u0430\u043B\u0438: SKU ${u} -> offer_id ${m}`)):console.warn(`\u26A0\uFE0F \u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D offer_id \u0434\u043B\u044F SKU ${u}`)}),console.log(`
\u{1F389} \u0418\u0442\u043E\u0433: \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u0441\u043E\u0438\u043D\u0432\u0435\u0441\u0442\u0430 \u0434\u043B\u044F ${Object.keys(d).length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`),console.log("\u{1F4CA} \u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043A\u0430:",{totalOfferIds:e.length,foundSkus:a.length,loadedPrices:Object.keys(o).length,mappedToOffers:Object.keys(d).length}),d},Je=async()=>{let e={},s=new Date,o=[];for(let n=0;n<7;n++){let i=new Date(s);i.setDate(i.getDate()-n),o.push({day:i.getDate(),month:i.getMonth()+1,year:i.getFullYear()})}console.log("\u{1F4CA} \u041F\u0430\u0440\u0430\u043B\u043B\u0435\u043B\u044C\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u043F\u0440\u043E\u0434\u0430\u0436 \u0437\u0430 \u043D\u0435\u0434\u0435\u043B\u044E");let a=o.flatMap(n=>pe.map(async i=>{try{let d=await fetch("https://api-seller.ozon.ru/v1/finance/realization/by-day",{method:"POST",headers:{"Content-Type":"application/json","Client-Id":i.client_id,"Api-Key":i.api_key},body:JSON.stringify(n)});return d.ok?{success:!0,data:await d.json(),account:i.name,date:n}:{success:!1,account:i.name,date:n}}catch(d){return{success:!1,account:i.name,date:n,error:d.message}}}));return(await Promise.allSettled(a)).forEach(n=>{n.status==="fulfilled"&&n.value.success&&n.value.data?.rows&&n.value.data.rows.forEach(i=>{let d=i.item?.sku?String(i.item.sku):null;if(d){let u=i.delivery_commission?.quantity||0,l=(i.seller_price_per_instance||0)*u;e[d]||(e[d]={qty:0,sum:0}),e[d].qty+=u,e[d].sum+=l}})}),console.log(`\u{1F389} \u041F\u0440\u043E\u0434\u0430\u0436\u0438 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B: ${Object.keys(e).length} SKU`),e},de=async()=>{try{let e=await ft();if(e.success)if(ce(e.files),e.files.length>0){let s=e.files.find(a=>a.name===`${te}.json`),o=s?s.name:e.files[0].name;await Se(o.replace(".json",""))}else try{let s=await Ce(te);s.success&&s.data&&(R(te),f(o=>({...o,competitorSelections:s.data.competitorSelections||{},parsedPrices:s.data.parsedPrices||{},uploadedFiles:s.data.uploadedFiles||{}})))}catch{console.log("\u041E\u0441\u043D\u043E\u0432\u043D\u043E\u0439 \u0444\u0430\u0439\u043B \u0434\u0430\u043D\u043D\u044B\u0445 \u0435\u0449\u0451 \u043D\u0435 \u0441\u043E\u0437\u0434\u0430\u043D")}}catch(e){console.warn("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A \u0444\u0430\u0439\u043B\u043E\u0432:",e)}},Oe=async()=>{if((Object.keys(t.competitorSelections).length>0||Object.keys(t.uploadedFiles).length>0)&&!ve){let s=Date.now(),o=localStorage.getItem("lastSaveTime");if(o&&s-parseInt(o)<3e4){console.log("\u23F3 \u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0440\u0430\u043D\u043E \u0434\u043B\u044F \u0430\u0432\u0442\u043E\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F");return}try{Ie(!0);let r={competitorSelections:t.competitorSelections,parsedPrices:t.parsedPrices,uploadedFiles:t.uploadedFiles,lastUpdated:new Date().toISOString()};await ee(r,A),localStorage.setItem("lastSaveTime",s.toString()),console.log("\u{1F4BE} \u0414\u0430\u043D\u043D\u044B\u0435 \u0430\u0432\u0442\u043E\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B")}catch(r){console.warn("\u041E\u0448\u0438\u0431\u043A\u0430 \u0430\u0432\u0442\u043E\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F:",r)}finally{Ie(!1)}}},Ze=async()=>{f(e=>({...e,isParsingPrices:!0})),I({current:0,total:0,status:"\u0418\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F..."});try{let e=t.selectedType?t.vmpData.filter(h=>h.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430===t.selectedType):t.vmpData,s=new Set(e.map(h=>h.\u0410\u0440\u0442\u0438\u043A\u0443\u043B)),o=[];Object.entries(t.competitorSelections).forEach(([h,b])=>{if(!s.has(h))return;b.forEach(P=>{if(P.link&&P.link.includes("ozon.ru")){let O=ge(P.link);O&&/^\d+$/.test(O)&&o.push({vmpSku:h,competitor:P,sku:O})}})});let a=[];if(e.forEach(h=>{let b=t.ozonData[h.\u0410\u0440\u0442\u0438\u043A\u0443\u043B];b&&b.sku&&a.push({sku:String(b.sku),article:h.\u0410\u0440\u0442\u0438\u043A\u0443\u043B})}),o.length===0&&a.length===0){alert(t.selectedType?`\u041D\u0435\u0442 \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0434\u043B\u044F \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 \u0432 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 "${t.selectedType}"`:"\u041D\u0435\u0442 \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0434\u043B\u044F \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430"),f(h=>({...h,isParsingPrices:!1}));return}let r=o.map(h=>h.sku),n=a.map(h=>h.sku),i=[...r,...n],d=[...new Set(i)];console.log(`\u{1F50D} \u041D\u0430\u0447\u0438\u043D\u0430\u0435\u043C \u043F\u0430\u0440\u0441\u0438\u043D\u0433 SKU \u0434\u043B\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 "${t.selectedType||"\u0412\u0441\u0435"}":`,d),I({current:0,total:d.length,status:t.selectedType?`\u041F\u0430\u0440\u0441\u0438\u043D\u0433 ${d.length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432 (${t.selectedType})...`:`\u041F\u043E\u0434\u0433\u043E\u0442\u043E\u0432\u043A\u0430 \u043A \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0443 ${d.length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432...`});try{if(!(await fetch(`${oe}/health`)).ok)throw new Error("\u0421\u0435\u0440\u0432\u0435\u0440 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}catch{alert(`\u26A0\uFE0F \u0421\u0435\u0440\u0432\u0435\u0440 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430 \u043D\u0435 \u0437\u0430\u043F\u0443\u0449\u0435\u043D.

\u0417\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u0435 \u0432 \u043E\u0442\u0434\u0435\u043B\u044C\u043D\u043E\u043C \u0442\u0435\u0440\u043C\u0438\u043D\u0430\u043B\u0435:
node server.js

\u0418\u043B\u0438 \u0435\u0441\u043B\u0438 \u0435\u0441\u0442\u044C \u043E\u0448\u0438\u0431\u043A\u0438:
npm install chromedriver
node server.js`),f(b=>({...b,isParsingPrices:!1}));return}I({current:0,total:d.length,status:"\u041E\u0436\u0438\u0434\u0430\u043D\u0438\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043F\u0430\u0440\u0441\u0435\u0440\u0430..."});let u=await fetch(`${oe}/parse-local`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({skus:d})});if(!u.ok){let h=await u.text();throw new Error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430: ${u.status} - ${h}`)}let l=await u.json();console.log("\u{1F4CA} \u041F\u043E\u043B\u0443\u0447\u0435\u043D\u044B \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430:",l);let m={};l.results&&Array.isArray(l.results)&&l.results.forEach(h=>{h.success&&h.price&&h.price!=="\u0426\u0435\u043D\u0430 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430"&&h.price!=="\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438"&&h.price!=="\u041D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E"&&h.price.includes("\u20BD")?(m[h.sku]=h.price,console.log(`\u2705 \u0414\u043E\u0431\u0430\u0432\u043B\u044F\u0435\u043C \u0446\u0435\u043D\u0443 \u0434\u043B\u044F ${h.sku}: ${h.price}`)):h.price&&console.log(`\u274C \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C ${h.sku}: ${h.price} (success: ${h.success})`)});let p={...t.competitorSelections},c={},g=new Date,y=g.toISOString().split("T")[0],w=g.toLocaleDateString("ru-RU");a.forEach(({sku:h,article:b})=>{m[h]&&(c[b]=m[h],console.log(`\u2705 \u0421\u043F\u0430\u0440\u0441\u0435\u043D\u0430 \u0446\u0435\u043D\u0430 \u0434\u043B\u044F \u043D\u0430\u0448\u0435\u0433\u043E \u0442\u043E\u0432\u0430\u0440\u0430 ${b} (SKU: ${h}): ${m[h]}`))});let S=0;o.forEach(({vmpSku:h,competitor:b,sku:k})=>{if(m[k]){p[h]||(p[h]=[]);let P=p[h].findIndex(O=>O.link===b.link);if(P!==-1){let O=p[h][P],Q=b.qty&&b.qty!==""&&b.qty!==0?b.qty:O.qty,K=b.sum&&b.sum!==""&&b.sum!==0?b.sum:O.sum,re=we(m[k]),ne=Q?parseFloat(String(Q)):void 0,fe=K?parseFloat(String(K)):void 0,J=O.priceHistory||[],ke=J.findIndex(G=>G.date.startsWith(y));if(ke!==-1)J[ke]={price:m[k],priceNumber:re,date:g.toISOString(),source:"ozon_card_parser",qty:Q,sum:K,qtyNumber:ne,sumNumber:fe};else{let G=J.length>0?J[J.length-1]:null;!G||G&&Math.abs(new Date(g).getTime()-new Date(G.date).getTime())>6*24*60*60*1e3?J.push({price:m[k],priceNumber:re,date:g.toISOString(),source:"ozon_card_parser",qty:Q,sum:K,qtyNumber:ne,sumNumber:fe}):J.push({price:m[k],priceNumber:re,date:g.toISOString(),source:"ozon_card_parser",qty:void 0,sum:void 0,qtyNumber:void 0,sumNumber:void 0})}p[h][P]={...O,ozonCardPrice:m[k],qty:Q,sum:K,lastUpdated:g.toISOString(),priceHistory:J}}else{let O=we(m[k]),Q=b.qty?parseFloat(String(b.qty)):void 0,K=b.sum?parseFloat(String(b.sum)):void 0;p[h].push({...b,ozonCardPrice:m[k],lastUpdated:g.toISOString(),priceHistory:[{price:m[k],priceNumber:O,date:g.toISOString(),source:"ozon_card_parser",qty:b.qty,sum:b.sum,qtyNumber:Q,sumNumber:K}]})}S++,console.log(`\u2705 \u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 \u0446\u0435\u043D\u0430 \u0434\u043B\u044F ${h} -> ${k}: ${m[k]}, qty: ${b.qty}, sum: ${b.sum}`)}});try{let h={date:y,timestamp:g.toISOString(),prices:m,competitorSelections:p,summary:{totalParsed:d.length,successful:S,failed:d.length-S}};await ee(h,`daily_data_${y}`);let b={...t.parsedPrices,[y]:{...t.parsedPrices[y]||{},...c}};await ee({competitorSelections:p,parsedPrices:b,uploadedFiles:t.uploadedFiles,lastUpdated:g.toISOString()},A),console.log("\u2705 \u0426\u0435\u043D\u044B \u0438 \u0438\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B")}catch(h){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0434\u0430\u043D\u043D\u044B\u0445:",h)}f(h=>({...h,competitorSelections:p,parsedPrices:{...h.parsedPrices,[y]:{...h.parsedPrices[y]||{},...c}},isParsingPrices:!1}));let E=Object.keys(c).length,D=S,j=E+D,N=d.length-j,x="";j>0?(x=`\u2705 \u041F\u0430\u0440\u0441\u0438\u043D\u0433 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D!

`,x+=`\u{1F4E6} \u041D\u0430\u0448\u0438\u0445 \u0442\u043E\u0432\u0430\u0440\u043E\u0432: ${E}
`,x+=`\u{1F3E2} \u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432: ${D}
`,x+=`\u{1F4CA} \u0412\u0441\u0435\u0433\u043E \u0441\u043F\u0430\u0440\u0441\u0435\u043D\u043E: ${j}`,N>0&&(x+=`
\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C: ${N}`),x+=`

\u{1F4C5} \u0414\u0430\u0442\u0430: ${w}
\u{1F4BE} \u0414\u0430\u043D\u043D\u044B\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B:
\u2022 \u041E\u0441\u043D\u043E\u0432\u043D\u043E\u0439 \u0444\u0430\u0439\u043B: ${A}
\u2022 \u0415\u0436\u0435\u0434\u043D\u0435\u0432\u043D\u044B\u0439 \u0444\u0430\u0439\u043B: daily_data_${y}.json`):x="\u274C \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0446\u0435\u043D\u044B \u043D\u0438 \u0434\u043B\u044F \u043E\u0434\u043D\u043E\u0433\u043E \u0442\u043E\u0432\u0430\u0440\u0430",alert(x),I({current:d.length,total:d.length,status:x}),setTimeout(()=>{I({current:0,total:0,status:""})},5e3)}catch(e){console.error("\u{1F4A5} \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430:",e),f(o=>({...o,isParsingPrices:!1}));let s=e.message||"\u041D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430";(s.includes("Failed to fetch")||s.includes("NetworkError"))&&(s="\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0442\u0438"),I({current:0,total:0,status:`\u274C \u041E\u0448\u0438\u0431\u043A\u0430: ${s}`}),alert(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0435:
${s}`),setTimeout(()=>{I({current:0,total:0,status:""})},5e3)}},Ge=(e,s)=>{let o=e.priceHistory.map(r=>({...r,priceNumber:r.priceNumber||we(r.price),qtyNumber:r.qtyNumber||r.qty&&parseFloat(String(r.qty))||0,sumNumber:r.sumNumber||r.sum&&parseFloat(String(r.sum))||0})),a={...e,priceHistory:o};Ne({competitor:a,productName:s})},Ye=async(e,s)=>{if(confirm("\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u044D\u0442\u043E\u0433\u043E \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u0430?")){let o={...t.competitorSelections};if(o[e]){o[e].splice(s,1);try{await ee({competitorSelections:o,parsedPrices:t.parsedPrices,uploadedFiles:t.uploadedFiles,lastUpdated:new Date().toISOString()},A),f(a=>({...a,competitorSelections:o}))}catch(a){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F:",a)}}}},Re=e=>{f(s=>({...s,selectedType:e}))},kt=e=>{let s=e.target.files?.[0];if(!s||!t.selectedType)return;if(s.size>10*1024*1024){alert("\u0424\u0430\u0439\u043B \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439. \u041C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u044B\u0439 \u0440\u0430\u0437\u043C\u0435\u0440: 10MB");return}let o=new FileReader;o.onload=a=>{let r=a.target?.result,n=window.XLSX.read(r,{type:"array"}),i=n.SheetNames[0],d=n.Sheets[i],u=window.XLSX.utils.sheet_to_json(d,{header:1,defval:"",raw:!1,blankrows:!1});console.log("\u{1F4CA} \u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435:",{sheetName:i,totalRows:u.length,headers:u[0],firstRow:u[1]});let m=u.slice(0,1e3+1);if(m.length<2){alert("\u0424\u0430\u0439\u043B \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u043C\u0430\u043B \u0438\u043B\u0438 \u043D\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u0442 \u0434\u0430\u043D\u043D\u044B\u0445");return}let p=m[0],c=Y(m);if(c.name===-1||c.link===-1||c.brand===-1||c.qty===-1||c.sum===-1){alert(`\u274C \u0412 \u0444\u0430\u0439\u043B\u0435 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B \u0432\u0441\u0435 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u044B\u0435 \u043A\u043E\u043B\u043E\u043D\u043A\u0438!

\u041E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u044B\u0435 \u043A\u043E\u043B\u043E\u043D\u043A\u0438:
1. \u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430
2. \u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0442\u043E\u0432\u0430\u0440
3. \u0411\u0440\u0435\u043D\u0434 (\u0438\u043B\u0438 \u041F\u0440\u043E\u0434\u0430\u0432\u0435\u0446)
4. \u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442\u0443\u043A\u0438
5. \u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E \u043D\u0430 \u0441\u0443\u043C\u043C\u0443, \u20BD

\u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u0438 \u0432 Excel \u0444\u0430\u0439\u043B\u0435.`);return}console.log("\u2705 \u0412\u0441\u0435 \u043A\u043E\u043B\u043E\u043D\u043A\u0438 \u043D\u0430\u0439\u0434\u0435\u043D\u044B \u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E"),console.log("\u{1F4CB} \u041F\u0440\u0438\u043C\u0435\u0440 \u0434\u0430\u043D\u043D\u044B\u0445 (\u043F\u0435\u0440\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430):",{name:m[1][c.name],link:m[1][c.link],brand:m[1][c.brand],qty:m[1][c.qty],sum:m[1][c.sum]});let g=m;console.log("\u{1F504} \u0410\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0434\u0431\u043E\u0440 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432 \u043F\u043E \u043E\u0431\u044A\u0451\u043C\u0443...");let y=je(g,c,t.vmpData),w={...t.competitorSelections};Object.entries(y).forEach(([j,N])=>{w[j]=N});let S=Object.keys(y).length,E=Object.values(y).reduce((j,N)=>j+N.length,0),D={...t.uploadedFiles,[t.selectedType]:g};ee({competitorSelections:w,parsedPrices:t.parsedPrices,uploadedFiles:D,lastUpdated:new Date().toISOString()},A).then(()=>{f(j=>({...j,uploadedFiles:D,competitorSelections:w})),alert(`\u2705 \u0424\u0430\u0439\u043B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D
\u0421\u0442\u0440\u043E\u043A: ${g.length-1}

\u{1F3AF} \u0410\u0432\u0442\u043E\u043F\u043E\u0434\u0431\u043E\u0440 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432:
\u2022 \u0422\u043E\u0432\u0430\u0440\u043E\u0432 \u0441 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u0430\u043C\u0438: ${S}
\u2022 \u0412\u0441\u0435\u0433\u043E \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432: ${E}

\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u044B \u043F\u043E\u0434\u043E\u0431\u0440\u0430\u043D\u044B \u043F\u043E \u0441\u0445\u043E\u0436\u0435\u043C\u0443 \u043E\u0431\u044A\u0451\u043C\u0443.`)}).catch(j=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0444\u0430\u0439\u043B\u0430:",j),alert("\u26A0\uFE0F \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0435 \u0444\u0430\u0439\u043B\u0430")})},o.readAsArrayBuffer(s)},et=(e,s)=>{let o=new Set(s.map(a=>a.originalIndex));T(o),f(a=>({...a,activeModalSku:e}))},De=()=>{f(e=>({...e,activeModalSku:null})),T(new Set),W(null),U(null)},tt=async()=>{if(!t.activeModalSku||!t.selectedType)return;let e=t.uploadedFiles[t.selectedType];if(!e||e.length<2)return;let s=e[0],o=Y(e);console.log("\u{1F4CB} \u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043A\u0438 Excel:",s),console.log("\u{1F5FA}\uFE0F \u0421\u043E\u043F\u043E\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043A\u043E\u043B\u043E\u043D\u043E\u043A:",o);let a=[];if(z.forEach(n=>{let i=e[n];if(i&&i.length>0){let d=o.link!==-1&&i[o.link]?String(i[o.link]).trim():"#",u=o.name!==-1&&i[o.name]?String(i[o.name]).trim():"\u041D\u0435\u0442 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",l=o.brand!==-1&&i[o.brand]?String(i[o.brand]).trim():"-",m="";if(o.qty!==-1&&i[o.qty]!==void 0&&i[o.qty]!==null){let w=i[o.qty];m=typeof w=="number"?new Intl.NumberFormat("ru-RU").format(w):String(w).trim()}let p="";if(o.sum!==-1&&i[o.sum]!==void 0&&i[o.sum]!==null){let w=i[o.sum];if(typeof w=="number")p=new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(w)+" \u20BD";else{let S=String(w).trim();p=S?S.includes("\u20BD")?S:S+" \u20BD":""}}let c=ge(d),g=m?parseFloat(m.replace(/\s+/g,"").replace(",",".")):void 0,y=p?parseFloat(p.replace(/[^\d.,]/g,"").replace(",",".")):void 0;console.log("\u{1F4DD} \u0414\u043E\u0431\u0430\u0432\u043B\u044F\u0435\u043C \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u0430:",{name:u,brand:l,link:d,qty:m,sum:p,sku:c}),a.push({name:u,brand:l,link:d,qty:m,sum:p,originalIndex:n,sku:c||void 0,lastUpdated:new Date().toISOString(),priceHistory:[{date:new Date().toISOString(),price:"",priceNumber:0,source:"initial_selection",qty:m,sum:p,qtyNumber:g,sumNumber:y}]})}}),a.length===0){alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u0437 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0440\u043E\u043A. \u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u0444\u043E\u0440\u043C\u0430\u0442 Excel \u0444\u0430\u0439\u043B\u0430.");return}let r={...t.competitorSelections,[t.activeModalSku]:a};try{await ee({competitorSelections:r,parsedPrices:t.parsedPrices,uploadedFiles:t.uploadedFiles,lastUpdated:new Date().toISOString()},A),console.log("\u2705 \u0414\u0430\u043D\u043D\u044B\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440"),alert(`\u2705 \u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E ${a.length} \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432`)}catch(n){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0435:",n),alert("\u26A0\uFE0F \u0414\u0430\u043D\u043D\u044B\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E, \u043D\u043E \u043D\u0435 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0435")}f(n=>({...n,competitorSelections:r,activeModalSku:null}))},st=e=>{T(s=>{let o=new Set(s);return o.has(e)?o.delete(e):o.add(e),o})},me=e=>{if(!e)return"\u041D\u0435 \u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0451\u043D";let s=r=>{let n=parseFloat(r.replace(",",".")),i=Math.round(n);return Math.abs(n-i)<.15?String(i):Number.isInteger(n)?String(n):n.toFixed(1).replace(/\.?0+$/,"")},o=[{regex:/(\d+[.,]?\d*)\s*(?:)?(?:|)?(?=\s|\/|,|$|[^\w--])/i,unit:"\u043B"},{regex:/(\d+[.,]?\d*)\s*(?=\s|\/|,|$|[^\w--])/i,unit:"\u043C\u043B"},{regex:/(\d+[.,]?\d*)\s*(?:)?(?:)?(?:|)?(?=\s|\/|,|$|[^\w--])/i,unit:"\u0433"},{regex:/(\d+[.,]?\d*)\s*(?:)?(?:|)?(?=\s|\/|,|$|[^\w--])/i,unit:"\u043A\u0433"}],a=e.match(/\s*(\d+)\s*[*x]\s*(\d+[.,]?\d*)\s*([-a-z]+)/i)||e.match(/(\d+)\s*[*x]\s*(\d+[.,]?\d*)\s*([-a-z]+)/i);if(a){let r=a[1],n=s(a[2]),i=a[3].toLowerCase();return`\u041D\u0430\u0431\u043E\u0440 ${r}\xD7${n}${i}`}for(let r of o){let n=e.match(r.regex);if(n)return`${s(n[1])} ${r.unit}`}return"\u041D\u0435 \u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0451\u043D"},Te=e=>{if(!e)return null;let s=[{regex:/(\d+[.,]?\d*)\s*(?:)?(?:|)?(?=\s|\/|,|$|[^\w--])/i,multiplier:1e3},{regex:/(\d+[.,]?\d*)\s*(?=\s|\/|,|$|[^\w--])/i,multiplier:1},{regex:/(\d+[.,]?\d*)\s*(?:)?(?:)?(?:|)?(?=\s|\/|,|$|[^\w--])/i,multiplier:1},{regex:/(\d+[.,]?\d*)\s*(?:)?(?:|)?(?=\s|\/|,|$|[^\w--])/i,multiplier:1e3}];for(let o of s){let a=e.match(o.regex);if(a)return parseFloat(a[1].replace(",","."))*o.multiplier}return null},nt=e=>({min:e*.95,max:e*1.05}),je=(e,s,o)=>{let a={},r=["\u0412\u041C\u041F\u0410\u0412\u0422\u041E","\u0420\u041C","\u0421\u043C\u0430\u0437\u043A\u0430.\u0440\u0443"];return(t.selectedType?o.filter(i=>i.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430===t.selectedType):o).forEach(i=>{let d=Te(i.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430);if(!d){console.log(`\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0438\u0442\u044C \u043E\u0431\u044A\u0451\u043C \u0434\u043B\u044F: ${i.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430}`);return}let u=nt(d),l=[];for(let p=1;p<e.length;p++){let c=e[p],g=c[s.brand]?String(c[s.brand]).trim():"";if(r.some(S=>S.toLowerCase()===g.toLowerCase()))continue;let y=c[s.name]?String(c[s.name]):"",w=Te(y);if(w&&w>=u.min&&w<=u.max){let S=c[s.link]?String(c[s.link]).trim():"",E=ge(S);l.push({name:y,brand:g,link:S,qty:c[s.qty]||0,sum:c[s.sum]||0,originalIndex:p,sku:E||void 0,priceHistory:[]})}}let m=l.sort((p,c)=>{let g=typeof p.sum=="number"?p.sum:parseFloat(String(p.sum||"0").replace(/[^\d.-]/g,""))||0;return(typeof c.sum=="number"?c.sum:parseFloat(String(c.sum||"0").replace(/[^\d.-]/g,""))||0)-g}).slice(0,20);m.length>0&&(a[i.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]=m,console.log(`\u2705 ${i.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430} (${d}\u043C\u043B): \u043D\u0430\u0439\u0434\u0435\u043D\u043E ${m.length} \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432 (\u043C\u0430\u043A\u0441. 20)`))}),a},be=e=>{if(!e)return null;let s=[/(\d{1,2})\s*[Ww]\s*[-]?\s*(\d{1,3})/,/(\d{1,2})[Ww](\d{1,3})/];for(let o of s){let a=e.match(o);if(a)return`${a[1]}W-${a[2]}`}return null},he=()=>t.selectedType?["\u041C\u043E\u0442\u043E\u0440\u043D\u044B\u0435 \u043C\u0430\u0441\u043B\u0430","\u0422\u0440\u0430\u043D\u0441\u043C\u0438\u0441\u0441\u0438\u043E\u043D\u043D\u044B\u0435 \u043C\u0430\u0441\u043B\u0430"].some(s=>t.selectedType?.toLowerCase().includes(s.toLowerCase())):!1,at=e=>{if(!V||!he())return[];let s=V,o=Y(s);if(o.name===-1||o.brand===-1||o.sum===-1)return[];let a={};for(let r=1;r<s.length;r++){let n=s[r];if((n[o.brand]?String(n[o.brand]).trim():"")!==e)continue;let d=n[o.name]?String(n[o.name]):"",u=be(d);if(!u)continue;let l=n[o.sum],m=typeof l=="number"?l:parseFloat(String(l||"0").replace(/[^\d.-]/g,""))||0;a[u]||(a[u]={count:0,totalSum:0}),a[u].count++,a[u].totalSum+=m}return Object.entries(a).map(([r,n])=>({name:r,count:n.count,totalSum:n.totalSum})).sort((r,n)=>n.totalSum-r.totalSum)},qe=()=>{if(!V)return[];let e=V,s=Y(e);if(s.brand===-1||s.sum===-1)return[];let o=["\u0412\u041C\u041F\u0410\u0412\u0422\u041E","\u0420\u041C","\u0421\u043C\u0430\u0437\u043A\u0430.\u0440\u0443"],a=[];if(t.filteredRows&&t.filteredRows.length>0)a=t.filteredRows;else for(let n=1;n<e.length;n++)a.push(n);let r={};return a.forEach(n=>{let i=e[n],d=i[s.brand]?String(i[s.brand]).trim():"";if(o.includes(d))return;let u=i[s.sum],l=typeof u=="number"?u:parseFloat(String(u||"0").replace(/[^\d.-]/g,""))||0;r[d]||(r[d]={count:0,totalSum:0}),r[d].count++,r[d].totalSum+=l}),Object.entries(r).map(([n,i])=>({name:n,count:i.count,totalSum:i.totalSum})).sort((n,i)=>i.totalSum-n.totalSum).slice(0,5)},Ee=(e,s)=>{if(!V)return[];let o=V,a=Y(o);if(a.name===-1||a.brand===-1||a.sum===-1)return[];let r=[];if(t.filteredRows&&t.filteredRows.length>0)r=t.filteredRows;else for(let i=1;i<o.length;i++)r.push(i);let n={};return r.forEach(i=>{let d=o[i];if((d[a.brand]?String(d[a.brand]).trim():"")!==e)return;let l=d[a.name]?String(d[a.name]):"";if(he()&&s&&be(l)!==s)return;let m=me(l),p=d[a.sum],c=typeof p=="number"?p:parseFloat(String(p||"0").replace(/[^\d.-]/g,""))||0;n[m]||(n[m]={count:0,totalSum:0}),n[m].count++,n[m].totalSum+=c}),Object.entries(n).map(([i,d])=>({name:i,count:d.count,totalSum:d.totalSum})).sort((i,d)=>d.totalSum-i.totalSum)},ye=()=>{if(!V)return[];let e=V,s=Y(e);if(s.name===-1||s.brand===-1||s.sum===-1)return[];let a=qe().map(m=>m.name),r=[];if(t.filteredRows&&t.filteredRows.length>0)r=t.filteredRows;else for(let m=1;m<e.length;m++)r.push(m);let n=he(),i=r.filter(m=>{let p=e[m],c=p[s.brand]?String(p[s.brand]).trim():"",g=p[s.name]?String(p[s.name]):"";return!(!a.includes(c)||$&&c!==$||n&&_&&be(g)!==_||L&&me(g)!==L)});if(n){let m={};i.forEach(g=>{let y=e[g],w=y[s.brand]?String(y[s.brand]).trim():"",S=y[s.name]?String(y[s.name]):"",E=be(S)||"\u0411\u0435\u0437 \u0432\u044F\u0437\u043A\u043E\u0441\u0442\u0438",D=me(S);m[w]||(m[w]={}),m[w][E]||(m[w][E]={}),m[w][E][D]||(m[w][E][D]=[]),m[w][E][D].push(g)});let p=[];return a.filter(g=>m[g]).forEach(g=>{let y=m[g];Object.values(y).forEach(w=>{Object.values(w).forEach(S=>{let E=S.map(D=>{let N=e[D][s.sum],x=typeof N=="number"?N:parseFloat(String(N||"0").replace(/[^\d.-]/g,""))||0;return{rowIndex:D,sum:x}}).sort((D,j)=>j.sum-D.sum).slice(0,5);p.push(...E.map(D=>D.rowIndex))})})}),p}let d={};i.forEach(m=>{let p=e[m],c=p[s.brand]?String(p[s.brand]).trim():"",g=p[s.name]?String(p[s.name]):"",y=me(g);d[c]||(d[c]={}),d[c][y]||(d[c][y]=[]),d[c][y].push(m)});let u=[];return a.filter(m=>d[m]).forEach(m=>{let p=d[m];Object.values(p).forEach(c=>{let g=c.map(y=>{let S=e[y][s.sum],E=typeof S=="number"?S:parseFloat(String(S||"0").replace(/[^\d.-]/g,""))||0;return{rowIndex:y,sum:E}}).sort((y,w)=>w.sum-y.sum).slice(0,5);u.push(...g.map(y=>y.rowIndex))})}),u},Pt=()=>{let e=window.XLSX.utils.book_new(),s=se.map(a=>{let r=t.ozonData[a.\u0410\u0440\u0442\u0438\u043A\u0443\u043B],n=t.competitorSelections[a.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]||[],i=t.ozonPrices[a.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]?.discount_percent,d=n.map(c=>{if(c.ozonCardPrice&&i){let y=(we(c.ozonCardPrice)-10)/(1-i);return`${Math.round(y*100)/100} \u20BD`}return"\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445"}),u=ae(t.parsedPrices,a.\u0410\u0440\u0442\u0438\u043A\u0443\u043B),l=u?.price,m=l||r?.customer_price||"\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445",p=l?` (\u0441\u043F\u0430\u0440\u0441\u0435\u043D\u043E ${u?.date})`:r?.customer_price?" (API)":"";return{\u0410\u0440\u0442\u0438\u043A\u0443\u043B:a.\u0410\u0440\u0442\u0438\u043A\u0443\u043B,\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430:a.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430,"\u041E\u0431\u044B\u0447\u043D\u0430\u044F \u0446\u0435\u043D\u0430 Ozon":r?`${r.price} \u20BD`:"\u0422\u043E\u0432\u0430\u0440 \u0432 \u0430\u0440\u0445\u0438\u0432\u0435","\u0426\u0435\u043D\u0430 \u043F\u043E Ozon Card":m+p,"\u0421\u043E\u0438\u043D\u0432\u0435\u0441\u0442, %":i?`${(i*100).toFixed(1)}%`:"\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445","\u0412\u0438\u0434 \u0442\u043E\u0432\u0430\u0440\u0430":a.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430,"\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u044B (\u0418\u043C\u0435\u043D\u0430)":n.map(c=>`${c.name} (${c.link})`).join(`
`),"\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u044B (\u0411\u0440\u0435\u043D\u0434)":n.map(c=>c.brand).join(`
`),"\u0426\u0435\u043D\u044B \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432 Ozon Card":n.map(c=>c.ozonCardPrice||"\u041D\u0435 \u0441\u043F\u0430\u0440\u0441\u0435\u043D\u0430").join(`
`),"\u0420\u0435\u043A\u043E\u043C\u0435\u043D\u0434\u043E\u0432\u0430\u043D\u043D\u044B\u0435 \u0446\u0435\u043D\u044B":d.join(`
`),"\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u044B (\u0428\u0442\u0443\u043A\u0438)":n.map(c=>c.qty).join(`
`),"\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u044B (\u0421\u0443\u043C\u043C\u0430)":n.map(c=>c.sum).join(`
`),"\u0414\u0430\u0442\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F":n.map(c=>c.lastUpdated?new Date(c.lastUpdated).toLocaleString():"").join(`
`)}}),o=window.XLSX.utils.json_to_sheet(s);window.XLSX.utils.book_append_sheet(e,o,"Price Data"),window.XLSX.writeFile(e,`price_regulation_${new Date().toISOString().slice(0,10)}.xlsx`)},ot=async()=>{let e=prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0438\u043C\u044F \u043D\u043E\u0432\u043E\u0433\u043E \u0444\u0430\u0439\u043B\u0430:",`data_${new Date().toISOString().slice(0,10)}`);if(e){let s=e.replace(/[^a-zA-Z0-9-_]/g,"_");R(s),f(o=>({...o,competitorSelections:{},uploadedFiles:{},parsedPrices:{}})),await de()}},Se=async e=>{try{let s=await Ce(e);s.success&&s.data?(R(e.replace(".json","")),f(o=>({...o,competitorSelections:s.data.competitorSelections||{},parsedPrices:s.data.parsedPrices||{},uploadedFiles:s.data.uploadedFiles||{}}))):alert(`\u0424\u0430\u0439\u043B "${e}" \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D \u0438\u043B\u0438 \u043F\u0443\u0441\u0442`)}catch(s){alert(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0444\u0430\u0439\u043B\u0430: ${s.message}`)}},rt=async e=>{if(confirm(`\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0444\u0430\u0439\u043B "${e}"?`))try{await wt(e),await de(),A===e.replace(".json","")&&(R(te),f(s=>({...s,competitorSelections:{},uploadedFiles:{},parsedPrices:{}}))),alert(`\u0424\u0430\u0439\u043B "${e}" \u0443\u0434\u0430\u043B\u0451\u043D`)}catch(s){alert(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0444\u0430\u0439\u043B\u0430: ${s.message}`)}},it=async()=>{try{let e=await vt();e.success&&(alert(`\u2705 \u0411\u044D\u043A\u0430\u043F \u0441\u043E\u0437\u0434\u0430\u043D: ${e.filename}
\u0420\u0430\u0437\u043C\u0435\u0440: ${(e.size/1024).toFixed(2)} KB`),await de())}catch(e){alert(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F \u0431\u044D\u043A\u0430\u043F\u0430: ${e.message}`)}},lt=()=>{let e=Object.keys(t.competitorSelections).length,s=Object.values(t.competitorSelections).reduce((r,n)=>r+(Array.isArray(n)?n.length:0),0),o=0;Object.values(t.competitorSelections).forEach(r=>{Array.isArray(r)&&r.forEach(n=>{n.priceHistory&&(o+=n.priceHistory.length)})});let a=q.find(r=>r.name===`${A}.json`);alert(`\u{1F4CA} \u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043A\u0430 \u0434\u0430\u043D\u043D\u044B\u0445:

\u0422\u0435\u043A\u0443\u0449\u0438\u0439 \u0444\u0430\u0439\u043B: ${A}
\u0422\u043E\u0432\u0430\u0440\u043E\u0432 \u0441 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u0430\u043C\u0438: ${e}
\u0412\u0441\u0435\u0433\u043E \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432: ${s}
\u0417\u0430\u043F\u0438\u0441\u0435\u0439 \u0432 \u0438\u0441\u0442\u043E\u0440\u0438\u0438: ${o}
\u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043D\u044B\u0445 Excel \u0444\u0430\u0439\u043B\u043E\u0432: ${Object.keys(t.uploadedFiles).length}
\u041F\u043E\u0441\u043B\u0435\u0434\u043D\u0435\u0435 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435: ${a?.lastUpdated?new Date(a.lastUpdated).toLocaleString():"\u043D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445"}
\u0420\u0430\u0437\u043C\u0435\u0440 \u0444\u0430\u0439\u043B\u0430: ${a?(a.size/1024).toFixed(2)+" KB":"\u043D\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043D\u043E"}
\u0412\u0441\u0435\u0433\u043E \u0444\u0430\u0439\u043B\u043E\u0432 \u0432 \u0441\u0438\u0441\u0442\u0435\u043C\u0435: ${q.length}`)},ct=async e=>{try{let s=await Ce(`daily_data_${e}`);s.success&&s.data?alert(`\u{1F4CA} \u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B \u0438\u0441\u0442\u043E\u0440\u0438\u0447\u0435\u0441\u043A\u0438\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0437\u0430 ${e}

\u0422\u043E\u0432\u0430\u0440\u043E\u0432: ${Object.keys(s.data.competitorSelections||{}).length}
\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432: ${Object.values(s.data.competitorSelections||{}).reduce((o,a)=>o+(Array.isArray(a)?a.length:0),0)}
\u0414\u0430\u0442\u0430 \u0441\u043E\u0437\u0434\u0430\u043D\u0438\u044F: ${new Date(s.data.timestamp).toLocaleString()}`):alert(`\u0418\u0441\u0442\u043E\u0440\u0438\u0447\u0435\u0441\u043A\u0438\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0437\u0430 ${e} \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B`)}catch(s){alert(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0441\u0442\u043E\u0440\u0438\u0447\u0435\u0441\u043A\u0438\u0445 \u0434\u0430\u043D\u043D\u044B\u0445: ${s.message}`)}},dt=ue(()=>Object.values(t.competitorSelections).some(e=>Array.isArray(e)&&e.length>0),[t.competitorSelections]),mt=ue(()=>{let e={};return t.vmpData.forEach(s=>{s.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430&&(e[s.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430]=(e[s.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430]||0)+1)}),Object.entries(e).sort((s,o)=>o[1]-s[1])},[t.vmpData]),se=ue(()=>{let e=t.vmpData;return t.selectedType&&(e=e.filter(s=>s.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430===t.selectedType)),e=e.filter(s=>{let o=t.ozonData[s.\u0410\u0440\u0442\u0438\u043A\u0443\u043B];return o&&!o.is_archived}),e},[t.vmpData,t.selectedType,t.ozonData]),ut=t.activeModalSku?t.vmpData.find(e=>e.\u0410\u0440\u0442\u0438\u043A\u0443\u043B===t.activeModalSku):null,Ae=t.activeModalSku?t.ozonData[t.activeModalSku]:null,Ue=Ae?.type_id?`type_${Ae.type_id}`:null,V=Ue?t.uploadedFiles[Ue]:null,{visibleProducts:Be,hiddenProducts:xe}=ue(()=>{let e=[],s=[],o=_e(t.parsedPrices);return se.forEach(a=>{let r=t.ozonData[a.\u0410\u0440\u0442\u0438\u043A\u0443\u043B],n=r?.sku?String(r.sku):null,i=n?t.salesData[n]:null,d=t.competitorSelections[a.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]||[],u=r?.type_id?`type_${r.type_id}`:null,l=u&&t.uploadedFiles[u],p=!!ae(t.parsedPrices,a.\u0410\u0440\u0442\u0438\u043A\u0443\u043B),c=i&&(i.qty>0||i.sum>0),g=d.length>0;l&&g&&c?e.push(a):s.push(a)}),{visibleProducts:e,hiddenProducts:s}},[se,t.ozonData,t.salesData,t.competitorSelections,t.parsedPrices,t.uploadedFiles]),pt=ue(()=>{let e={},s=new Set(Be.map(o=>o.\u0410\u0440\u0442\u0438\u043A\u0443\u043B));return se.forEach(o=>{let r=t.ozonData[o.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]?.type_id,n=r?t.ozonCategories[r]||"\u0422\u0438\u043F \u043D\u0435 \u043E\u043F\u0440\u0435\u0434\u0435\u043B\u0451\u043D":"\u0411\u0435\u0437 \u0442\u0438\u043F\u0430",i=r?.toString()||"no-type";e[i]||(e[i]={categoryId:r||null,categoryName:n,items:[],visibleItems:[]}),e[i].items.push(o),s.has(o.\u0410\u0440\u0442\u0438\u043A\u0443\u043B)&&e[i].visibleItems.push(o)}),Object.values(e).sort((o,a)=>!o.categoryId&&a.categoryId?1:o.categoryId&&!a.categoryId?-1:o.categoryName.localeCompare(a.categoryName,"ru"))},[se,Be,t.ozonData,t.ozonCategories]);return t.loading?React.createElement("div",{className:"text-center mt-5"},React.createElement("div",{className:"spinner-border text-primary",role:"status"}),React.createElement("p",{className:"mt-2"},"Loading data...")):t.error?React.createElement("div",{className:"alert alert-danger m-4"},t.error):React.createElement("div",{className:"container-fluid pb-5"},React.createElement("h1",{className:"mb-4 text-center"},"\u0420\u0435\u0433\u0443\u043B\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0446\u0435\u043D"),t.usingFallback&&React.createElement("div",{className:"alert alert-warning mb-3"},React.createElement("strong",null,"\u041F\u0440\u0438\u043C\u0435\u0447\u0430\u043D\u0438\u0435:")," \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u044B \u043A\u044D\u0448\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 (data_cache.json), \u0442\u0430\u043A \u043A\u0430\u043A \u043F\u0440\u044F\u043C\u043E\u0439 \u0434\u043E\u0441\u0442\u0443\u043F \u043A API \u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0435\u043D."),M.total>0&&React.createElement("div",{className:"alert alert-info mb-3"},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("div",null,React.createElement("strong",null,"\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 Ozon \u0434\u0430\u043D\u043D\u044B\u0445:")," ",M.stage),React.createElement("div",null,M.current," / ",M.total)),React.createElement("div",{className:"progress mt-2"},React.createElement("div",{className:"progress-bar progress-bar-striped progress-bar-animated",role:"progressbar",style:{width:`${M.current/M.total*100}%`}},Math.round(M.current/M.total*100),"%"))),React.createElement("div",{className:"alert alert-info mb-3",style:{display:"none"}},React.createElement("div",{className:"d-flex justify-content-between align-items-center"},React.createElement("div",null,React.createElement("strong",null,"\u0424\u0430\u0439\u043B \u0434\u0430\u043D\u043D\u044B\u0445:"),React.createElement("select",{className:"form-select form-select-sm d-inline-block w-auto mx-2",value:A,onChange:e=>Se(e.target.value)},React.createElement("option",{value:te},"\u041E\u0441\u043D\u043E\u0432\u043D\u043E\u0439 \u0444\u0430\u0439\u043B"),q.map((e,s)=>React.createElement("option",{key:s,value:e.name.replace(".json","")},e.name," (",e.itemCount," \u0442\u043E\u0432\u0430\u0440\u043E\u0432)"))),ve&&React.createElement("span",{className:"text-muted ms-2"},"\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435...")),React.createElement("div",{className:"btn-group btn-group-sm"},React.createElement("button",{className:"btn btn-outline-primary",onClick:()=>Ke(!Fe)},"\u{1F4C1} \u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u0444\u0430\u0439\u043B\u0430\u043C\u0438"),React.createElement("button",{className:"btn btn-outline-success",onClick:ot},"\u2795 \u041D\u043E\u0432\u044B\u0439 \u0444\u0430\u0439\u043B"),React.createElement("button",{className:"btn btn-outline-warning",onClick:lt},"\u{1F4CA} \u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043A\u0430"),React.createElement("button",{className:"btn btn-outline-secondary",onClick:it},"\u{1F4BE} \u0411\u044D\u043A\u0430\u043F")))),Fe&&React.createElement("div",{className:"card mb-3"},React.createElement("div",{className:"card-header"},React.createElement("h5",{className:"mb-0"},"\u{1F4C1} \u0423\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u0444\u0430\u0439\u043B\u0430\u043C\u0438 \u0434\u0430\u043D\u043D\u044B\u0445")),React.createElement("div",{className:"card-body"},React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm table-hover"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"\u0418\u043C\u044F \u0444\u0430\u0439\u043B\u0430"),React.createElement("th",null,"\u0420\u0430\u0437\u043C\u0435\u0440"),React.createElement("th",null,"\u0418\u0437\u043C\u0435\u043D\u0451\u043D"),React.createElement("th",null,"\u0422\u043E\u0432\u0430\u0440\u043E\u0432"),React.createElement("th",null,"\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432"),React.createElement("th",null,"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044F"))),React.createElement("tbody",null,q.map((e,s)=>React.createElement("tr",{key:s,className:A===e.name.replace(".json","")?"table-active":""},React.createElement("td",null,e.name),React.createElement("td",null,(e.size/1024).toFixed(2)," KB"),React.createElement("td",null,new Date(e.modified).toLocaleDateString()),React.createElement("td",null,e.itemCount),React.createElement("td",null,e.competitorCount),React.createElement("td",null,React.createElement("button",{className:"btn btn-sm btn-outline-primary me-1",onClick:()=>Se(e.name.replace(".json","")),disabled:A===e.name.replace(".json","")},"\u{1F4C2} \u041E\u0442\u043A\u0440\u044B\u0442\u044C"),e.name.startsWith("daily_data_")&&React.createElement("button",{className:"btn btn-sm btn-outline-info me-1",onClick:()=>ct(e.name.replace("daily_data_","").replace(".json",""))},"\u{1F4C5} \u0418\u0441\u0442\u043E\u0440\u0438\u044F"),React.createElement("button",{className:"btn btn-sm btn-outline-danger",onClick:()=>rt(e.name)},"\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0438\u0442\u044C"))))))),React.createElement("div",{className:"text-end"},React.createElement("button",{className:"btn btn-sm btn-secondary",onClick:de},"\u{1F504} \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A")))),React.createElement("div",{className:"tag-cloud"},React.createElement("div",{className:"d-flex justify-content-between align-items-center mb-3"},React.createElement("h5",{className:"m-0"},"\u0424\u0438\u043B\u044C\u0442\u0440 \u043F\u043E \u0432\u0438\u0434\u0443 \u0442\u043E\u0432\u0430\u0440\u0430:"),React.createElement("button",{className:"btn btn-secondary btn-sm",onClick:()=>Re(null)},"\u0421\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u0444\u0438\u043B\u044C\u0442\u0440")),React.createElement("div",{className:"d-flex flex-wrap gap-2"},mt.map(([e,s])=>React.createElement("span",{key:e,className:`badge rounded-pill border tag p-2 ${t.selectedType===e?"active":"bg-light text-dark"}`,onClick:()=>Re(e)},e," (",s,")")))),React.createElement("div",{className:"mb-3 d-flex gap-2 flex-wrap"},dt&&React.createElement("button",{className:"btn btn-warning",onClick:Ze,disabled:t.isParsingPrices},t.isParsingPrices?React.createElement(React.Fragment,null,React.createElement("span",{className:"spinner-border spinner-border-sm me-2",role:"status"}),"\u041F\u0430\u0440\u0441\u0438\u043D\u0433..."):"\u041F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0446\u0435\u043D\u044B \u043F\u043E Ozon Card")),React.createElement("div",{className:"main-table-container"},React.createElement("table",{className:"product-table table-hover align-middle"},React.createElement("thead",{className:"table-light sticky-top"},React.createElement("tr",null,React.createElement("th",{style:{width:"30px"},title:"\u041F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u0435: \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442 \u0434\u0435\u0448\u0435\u0432\u043B\u0435 \u0438 \u043F\u0440\u043E\u0434\u0430\u0451\u0442 \u0431\u043E\u043B\u044C\u0448\u0435"},"\u26A0\uFE0F"),React.createElement("th",{style:{width:"80px"}},"\u0424\u043E\u0442\u043E"),React.createElement("th",{style:{width:"25%"}},"\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430"),React.createElement("th",{style:{width:"10%"}},"\u0426\u0435\u043D\u0430 Ozon \u0437\u0430\u043B\u0438\u0432\u043E\u0447\u043D\u0430\u044F"),React.createElement("th",{style:{width:"15%"}},"\u0426\u0435\u043D\u0430 \u043F\u043E Ozon Card"),React.createElement("th",{style:{width:"10%"}},"\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442"),React.createElement("th",{style:{width:"12%"}},"\u0421\u0443\u043C\u043C\u0430 \u0437\u0430\u043A\u0430\u0437\u0430"),React.createElement("th",{style:{width:"100px"}},"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044F"))),React.createElement("tbody",null,pt.map((e,s)=>{let o=t.collapsedCategories[e.categoryId?.toString()||"no-type"],a=`type_${e.categoryId||"no-type"}`,r=t.uploadedFiles[a];return React.createElement(React.Fragment,{key:`group-${e.categoryId||"no-type"}-${s}`},React.createElement("tr",{className:"table-light"},React.createElement("td",{colSpan:8,className:"py-2 px-3",style:{background:"#f8f9fa"}},React.createElement("div",{className:"d-flex align-items-center justify-content-between"},React.createElement("div",{className:"d-flex align-items-center",style:{cursor:"pointer"},onClick:()=>{let n=e.categoryId?.toString()||"no-type";f(i=>({...i,collapsedCategories:{...i.collapsedCategories,[n]:!i.collapsedCategories[n]}}))}},React.createElement("i",{className:`bi ${o?"bi-chevron-right":"bi-chevron-down"} me-2 text-muted`}),React.createElement("span",{className:"text-muted",style:{fontSize:"0.9rem"}},e.categoryName),React.createElement("span",{className:"badge bg-light text-muted border ms-2"},e.visibleItems.length>0?`${e.visibleItems.length} / ${e.items.length}`:e.items.length)),React.createElement("div",{className:"d-flex align-items-center gap-2",onClick:n=>n.stopPropagation()},r?React.createElement("span",{className:"text-muted small"},React.createElement("i",{className:"bi bi-check"})," \u0424\u0430\u0439\u043B \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D (",r.length-1," \u0441\u0442\u0440\u043E\u043A)"):React.createElement("span",{className:"text-muted small"},"\u041D\u0435\u0442 \u0444\u0430\u0439\u043B\u0430"),React.createElement("label",{className:"btn btn-sm btn-outline-secondary mb-0",style:{cursor:"pointer"}},React.createElement("i",{className:"bi bi-upload me-1"}),r?"\u0417\u0430\u043C\u0435\u043D\u0438\u0442\u044C":"\u0417\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C XLS",React.createElement("input",{type:"file",accept:".xls,.xlsx",style:{display:"none"},onChange:n=>{let i=n.target.files?.[0];if(!i)return;let d=new FileReader;d.onload=u=>{try{let l=new Uint8Array(u.target?.result),m=window.XLSX.read(l,{type:"array"}),p=m.Sheets[m.SheetNames[0]],c=window.XLSX.utils.sheet_to_json(p,{header:1}),g=Y(c),y=e.items,w=je(c,g,y),S={...t.competitorSelections};Object.entries(w).forEach(([N,x])=>{S[N]=x});let E=Object.keys(w).length,D=Object.values(w).reduce((N,x)=>N+x.length,0),j={...t.uploadedFiles,[a]:c};ee({competitorSelections:S,parsedPrices:t.parsedPrices,uploadedFiles:j,lastUpdated:new Date().toISOString()},A).then(()=>{f(N=>({...N,uploadedFiles:j,competitorSelections:S})),console.log(`\u2705 \u0424\u0430\u0439\u043B \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D \u0434\u043B\u044F ${e.categoryName}: ${c.length-1} \u0441\u0442\u0440\u043E\u043A, ${E} \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0441 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u0430\u043C\u0438 (${D} \u0432\u0441\u0435\u0433\u043E)`)})}catch(l){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0447\u0442\u0435\u043D\u0438\u044F Excel:",l),alert("\u041E\u0448\u0438\u0431\u043A\u0430 \u0447\u0442\u0435\u043D\u0438\u044F \u0444\u0430\u0439\u043B\u0430 Excel")}},d.readAsArrayBuffer(i),n.target.value=""}})))))),!o&&e.visibleItems.map((n,i)=>{let d=t.ozonData[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B],u=d?.primary_image||d?.images?.[0],l=t.competitorSelections[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]||[],m=r,c=ae(t.parsedPrices,n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B)?.price,g=d?.sku?String(d.sku):null,y=g?t.salesData[g]:null,w=t.ozonPrices[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]?.discount_percent||0,S=y?.sum?y.sum*(1-w):0,D=(c&&parseFloat(String(c).replace(/[^\d.,]/g,"").replace(",","."))||0)*.9,j=l.some(N=>{let h=(N.ozonCardPrice&&parseFloat(String(N.ozonCardPrice).replace(/[^\d.,]/g,"").replace(",","."))||0)*.9,b=typeof N.qty=="number"?N.qty:parseFloat(String(N.qty||"0").replace(/[^\d.-]/g,""))||0,k=typeof N.sum=="number"?N.sum:parseFloat(String(N.sum||"0").replace(/[^\d.-]/g,""))||0;return D>0&&h>0&&h<D&&(y?.qty&&b>y.qty||S>0&&k>S)});return React.createElement(React.Fragment,{key:`${n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B}-${i}`},React.createElement("tr",{className:`product-row ${j?"table-warning":""}`},React.createElement("td",{className:"text-center"},j&&React.createElement("i",{className:"bi bi-exclamation-triangle-fill text-danger",title:"\u0415\u0441\u0442\u044C \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442 \u0434\u0435\u0448\u0435\u0432\u043B\u0435 \u0441 \u0431\u043E\u043B\u044C\u0448\u0438\u043C\u0438 \u043F\u0440\u043E\u0434\u0430\u0436\u0430\u043C\u0438!",style:{fontSize:"1.2rem"}})),React.createElement("td",null,u?React.createElement("img",{src:u,className:"product-img shadow-sm",alt:n.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430,onClick:()=>C(u)}):React.createElement("span",{className:"text-muted small"},"\u041D\u0435\u0442 \u0444\u043E\u0442\u043E")),React.createElement("td",null,React.createElement("div",{className:"fw-medium"},n.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430),React.createElement("div",{className:"small text-muted"},n.\u0412\u0438\u0434\u0422\u043E\u0432\u0430\u0440\u0430),React.createElement("div",{className:"small"},d?.sku?React.createElement("a",{href:`https://www.ozon.ru/product/${d.sku}`,target:"_blank",rel:"noreferrer",className:"text-decoration-none text-muted"},React.createElement("i",{className:"bi bi-link"})," \u0421\u0441\u044B\u043B\u043A\u0430"):React.createElement("span",{className:"text-muted"},"\u0410\u0440\u0442: ",n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B))),React.createElement("td",null,d?React.createElement("div",{className:"price-display price-regular"},d.price," \u20BD",t.ozonPrices[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]?.discount_percent&&React.createElement("div",{className:"small soinvest"},React.createElement("i",{className:"bi bi-percent text-muted mt-1"})," \u0421\u043E\u0438\u043D\u0432\u0435\u0441\u0442: ",(t.ozonPrices[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]?.discount_percent*100).toFixed(1),"%")):React.createElement("span",{className:"text-danger"},"\u0410\u0440\u0445\u0438\u0432/\u041D\u0435\u0442")),React.createElement("td",null,(()=>{let N=ae(t.parsedPrices,n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B),x=N?.price,h=N?.date,b=k=>{let P=parseFloat(k.replace(/[^\d.,]/g,"").replace(",","."))||0;if(P<=0)return k;let O=P*.9;return`${new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(O)} \u20BD`};if(x){let k=new Date().toISOString().split("T")[0],P=h===k;return React.createElement("div",{className:"price-display price-card"},b(x),React.createElement("div",{className:"small text-muted"},React.createElement("i",{className:"bi bi-check-circle"})," ",P?"\u0421\u043F\u0430\u0440\u0441\u0435\u043D\u043E":h))}else return d?.customer_price?React.createElement("div",{className:"price-display price-card"},b(d.customer_price),React.createElement("div",{className:"small text-muted"},React.createElement("i",{className:"bi bi-cloud"})," API - 10%")):React.createElement("span",{className:"text-muted small"},"\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445")})()),React.createElement("td",null,(()=>{let N=d?.sku?String(d.sku):null,x=N?t.salesData[N]:null;return x?.qty?React.createElement("span",null,new Intl.NumberFormat("ru-RU").format(x.qty)):React.createElement("span",{className:"text-muted"},"\u2014")})()),React.createElement("td",null,(()=>{let N=d?.sku?String(d.sku):null,x=N?t.salesData[N]:null,h=t.ozonPrices[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]?.discount_percent||0;if(x?.sum){let b=x.sum*(1-h),k=`\u0421\u0443\u043C\u043C\u0430 \u0438\u0437 API: ${new Intl.NumberFormat("ru-RU").format(x.sum)} \u20BD
\u0421\u043E\u0438\u043D\u0432\u0435\u0441\u0442: ${(h*100).toFixed(1)}%
\u0424\u043E\u0440\u043C\u0443\u043B\u0430: ${new Intl.NumberFormat("ru-RU").format(x.sum)} \xD7 (1 - ${(h*100).toFixed(1)}%) = ${new Intl.NumberFormat("ru-RU").format(b)} \u20BD`;return React.createElement("span",{title:k,style:{cursor:"help"}},new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(b)," \u20BD")}return React.createElement("span",{className:"text-muted"},"\u2014")})()),React.createElement("td",null,React.createElement("button",{className:`btn btn-sm ${l.length>0,"btn-outline-secondary"}`,disabled:!m,title:m?"\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432":"\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0412\u0438\u0434 \u0422\u043E\u0432\u0430\u0440\u0430 \u0438 \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 Excel",onClick:()=>et(n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B,l)},l.length>0?React.createElement(React.Fragment,null,"\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u044B: ",l.length):React.createElement(React.Fragment,null,React.createElement("i",{className:"bi bi-plus"})," \u0412\u044B\u0431\u0440\u0430\u0442\u044C")))),l.length>0&&React.createElement("tr",null,React.createElement("td",{colSpan:8,className:"p-0 border-0"},React.createElement("div",{className:"competitors-table-container slide-down mb-4"},React.createElement("div",{className:"d-flex"},React.createElement("div",{className:"flex-grow-1"},React.createElement("table",{className:"competitors-table"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",{style:{width:"30px"}}),React.createElement("th",{style:{width:"80px"}},"\u0414\u0435\u0439\u0441\u0442\u0432\u0438\u044F"),React.createElement("th",{style:{width:"25%"}},"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430"),React.createElement("th",{style:{width:"10%"}}),React.createElement("th",{style:{width:"15%"}},"\u0426\u0435\u043D\u0430 \u043F\u043E Ozon Card"),React.createElement("th",{style:{width:"10%"}},"\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442"),React.createElement("th",{style:{width:"12%"}},"\u0421\u0443\u043C\u043C\u0430 \u0437\u0430\u043A\u0430\u0437\u0430"))),React.createElement("tbody",null,(()=>{let N=t.expandedProducts[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B],x=[...l].sort((b,k)=>{let P=typeof b.sum=="number"?b.sum:parseFloat(String(b.sum||"0").replace(/[^\d.-]/g,""))||0;return(typeof k.sum=="number"?k.sum:parseFloat(String(k.sum||"0").replace(/[^\d.-]/g,""))||0)-P}),h=N?x:x.slice(0,3);return React.createElement(React.Fragment,null,h.map((b,k)=>{let P=l.findIndex(ie=>ie===b),Q=ae(t.parsedPrices,n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B)?.price,K=t.ozonData[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B],re=K?.sku?String(K.sku):null,ne=re?t.salesData[re]:null,fe=t.ozonPrices[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]?.discount_percent||0,J=ne?.sum?ne.sum*(1-fe):0,G=(Q&&parseFloat(String(Q).replace(/[^\d.,]/g,"").replace(",","."))||0)*.9,Pe=(b.ozonCardPrice&&parseFloat(String(b.ozonCardPrice).replace(/[^\d.,]/g,"").replace(",","."))||0)*.9,bt=typeof b.qty=="number"?b.qty:parseFloat(String(b.qty||"0").replace(/[^\d.-]/g,""))||0,ht=typeof b.sum=="number"?b.sum:parseFloat(String(b.sum||"0").replace(/[^\d.-]/g,""))||0,Me=G>0&&Pe>0&&Pe<G&&(ne?.qty&&bt>ne.qty||J>0&&ht>J);return React.createElement("tr",{key:`${n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B}-competitor-${k}`,className:Me?"table-danger":""},React.createElement("td",{className:"text-center"},Me&&React.createElement("i",{className:"bi bi-exclamation-triangle-fill text-danger",title:`\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442 \u0434\u0435\u0448\u0435\u0432\u043B\u0435 (${Pe} \u20BD < ${G} \u20BD) \u0438 \u043F\u0440\u043E\u0434\u0430\u0451\u0442 \u0431\u043E\u043B\u044C\u0448\u0435!`,style:{fontSize:"1rem"}})),React.createElement("td",null,React.createElement("div",{className:"d-flex gap-1"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:ie=>{ie.stopPropagation(),Ge(b,n.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430)},title:"\u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u0438\u0441\u0442\u043E\u0440\u0438\u044E \u0438 \u0433\u0440\u0430\u0444\u0438\u043A\u0438"},React.createElement("i",{className:"bi bi-graph-up"})),React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:ie=>{ie.stopPropagation(),Ye(n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B,P)},title:"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u0430"},React.createElement("i",{className:"bi bi-x-lg"})))),React.createElement("td",null,React.createElement("div",{title:String(b.name),style:{fontSize:"0.9rem"}},String(b.name).substring(0,80),String(b.name).length>80?"...":""),React.createElement("div",{className:"small text-muted"},React.createElement("a",{href:b.link,target:"_blank",rel:"noreferrer",className:"text-decoration-none text-muted"},React.createElement("i",{className:"bi bi-link-45deg"})," Ozon"),React.createElement("span",{className:"ms-2"},b.brand))),React.createElement("td",null),React.createElement("td",null,b.ozonCardPrice?(()=>{let Le=(parseFloat(String(b.ozonCardPrice).replace(/[^\d.,]/g,"").replace(",","."))||0)*.9;return React.createElement("span",{className:"badge badge-success",title:`\u0421\u043F\u0430\u0440\u0441\u0435\u043D\u043E: ${b.ozonCardPrice}, -10% = ${Le.toFixed(0)} \u20BD
\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${b.lastUpdated?new Date(b.lastUpdated).toLocaleString():"\u043D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445"}`},new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(Le)," \u20BD")})():React.createElement("span",{className:"text-muted small"},"\u041D\u0435 \u0441\u043F\u0430\u0440\u0441\u0435\u043D\u0430")),React.createElement("td",{className:"text-center"},b.qty&&b.qty!==""&&b.qty!==0?React.createElement("span",null,b.qty):React.createElement("span",{className:"text-muted"},"\u2014")),React.createElement("td",{className:"text-end"},b.sum&&b.sum!==""&&b.sum!==0?React.createElement("span",null,b.sum," \u20BD"):React.createElement("span",{className:"text-muted"},"\u2014")))}),x.length>3&&React.createElement("tr",null,React.createElement("td",{colSpan:7,className:"text-center border-top-0"},React.createElement("button",{className:"btn btn-sm btn-outline-secondary",onClick:b=>{b.stopPropagation(),f(k=>({...k,expandedProducts:{...k.expandedProducts,[n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]:!N}}))}},N?React.createElement(React.Fragment,null,React.createElement("i",{className:"bi bi-chevron-up"})," \u0421\u043A\u0440\u044B\u0442\u044C (",x.length-3,")"):React.createElement(React.Fragment,null,React.createElement("i",{className:"bi bi-chevron-down"})," \u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u0432\u0441\u0435 (",x.length,")")))))})()))),(()=>{let x=ae(t.parsedPrices,n.\u0410\u0440\u0442\u0438\u043A\u0443\u043B)?.price,h=l.length>0&&l.every(P=>P.ozonCardPrice&&P.ozonCardPrice!=="");if(!x||!h)return React.createElement("div",{className:"ms-3 p-3 bg-light rounded text-center",style:{minWidth:"150px",opacity:.5}},React.createElement("div",{className:"small text-muted mb-1"},"\u0421\u0440\u0435\u0434\u043D\u0435\u0432\u0437\u0432\u0435\u0448\u0435\u043D\u043D\u0430\u044F \u0446\u0435\u043D\u0430"),React.createElement("div",{className:"fs-6 text-muted"},React.createElement("i",{className:"bi bi-hourglass-split"}),React.createElement("div",{className:"small mt-1"},"\u041E\u0436\u0438\u0434\u0430\u043D\u0438\u0435 \u043F\u0430\u0440\u0441\u0438\u043D\u0433\u0430")));let b=0,k=0;if(l.forEach(P=>{let O=typeof P.qty=="number"?P.qty:parseFloat(String(P.qty||"0").replace(/[^\d.-]/g,""))||0,K=(P.ozonCardPrice&&parseFloat(String(P.ozonCardPrice).replace(/[^\d.,]/g,"").replace(",","."))||0)*.9;O>0&&K>0&&(b+=O,k+=O*K)}),b>0){let P=k/b,O=P*.98;return React.createElement("div",{className:"ms-3 p-3 bg-light rounded text-center",style:{minWidth:"180px"}},React.createElement("div",{className:"small text-muted mb-1"},"\u0421\u0440\u0435\u0434\u043D\u0435\u0432\u0437\u0432\u0435\u0448\u0435\u043D\u043D\u0430\u044F"),React.createElement("div",{className:"text-muted",style:{fontSize:"0.9rem"}},new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(P)," \u20BD"),React.createElement("div",{className:"small text-muted mt-2 mb-1"},"\u0420\u0435\u043A\u043E\u043C\u0435\u043D\u0434\u043E\u0432\u0430\u043D\u043D\u0430\u044F"),React.createElement("div",{className:"fw-medium",style:{fontSize:"1.25rem"}},new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(O)," \u20BD"),React.createElement("div",{className:"small text-muted mt-1",style:{opacity:.7}},"(\u22122%)"))}return React.createElement("div",{className:"ms-3 p-3 bg-light rounded text-center",style:{minWidth:"150px"}},React.createElement("div",{className:"small text-muted mb-1"},"\u0421\u0440\u0435\u0434\u043D\u0435\u0432\u0437\u0432\u0435\u0448\u0435\u043D\u043D\u0430\u044F \u0446\u0435\u043D\u0430"),React.createElement("div",{className:"fs-4 text-muted"},"\u2014"))})())))),l.length===0&&React.createElement("tr",null,React.createElement("td",{colSpan:8,className:"p-0 border-0"},React.createElement("div",{className:"competitors-empty"},React.createElement("i",{className:"bi bi-people"}),React.createElement("div",null,"\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u044B \u043D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u044B")))))}))}))),xe.length>0&&React.createElement("details",{className:"mt-4"},React.createElement("summary",{className:"cursor-pointer text-muted mb-2 p-2 bg-light rounded"},React.createElement("i",{className:"bi bi-eye-slash me-2"}),"\u0421\u043A\u0440\u044B\u0442\u044B\u0435 \u0442\u043E\u0432\u0430\u0440\u044B (",xe.length,") \u2014",(()=>{let e=t.selectedType&&t.uploadedFiles[t.selectedType],s=_e(t.parsedPrices);return e?s?"\u0431\u0435\u0437 \u0441\u043F\u0430\u0440\u0441\u0435\u043D\u043D\u043E\u0439 \u0446\u0435\u043D\u044B, \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432 \u0438\u043B\u0438 \u043F\u0440\u043E\u0434\u0430\u0436":"\u0431\u0435\u0437 \u043F\u0440\u043E\u0434\u0430\u0436":"\u0444\u0430\u0439\u043B \u043D\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D"})()),React.createElement("table",{className:"product-table table-hover align-middle mt-2",style:{opacity:.7}},React.createElement("thead",{className:"table-light"},React.createElement("tr",null,React.createElement("th",{style:{width:"80px"}},"\u0424\u043E\u0442\u043E"),React.createElement("th",{style:{minWidth:"200px"}},"\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430"),React.createElement("th",null,"\u0426\u0435\u043D\u0430 \u043F\u043E Ozon Card"),React.createElement("th",{style:{width:"100px"}},"\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442"),React.createElement("th",{style:{width:"120px"}},"\u0421\u0443\u043C\u043C\u0430 \u0437\u0430\u043A\u0430\u0437\u0430"),React.createElement("th",null,"\u041A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u044B"),React.createElement("th",null,"\u041F\u0440\u0438\u0447\u0438\u043D\u0430 \u0441\u043A\u0440\u044B\u0442\u0438\u044F"))),React.createElement("tbody",null,xe.map((e,s)=>{let o=t.ozonData[e.\u0410\u0440\u0442\u0438\u043A\u0443\u043B],a=o?.primary_image||o?.images?.[0],r=o?.sku?String(o.sku):null,n=r?t.salesData[r]:null,i=t.competitorSelections[e.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]||[],d=ae(t.parsedPrices,e.\u0410\u0440\u0442\u0438\u043A\u0443\u043B),u=[],l=t.selectedType&&t.uploadedFiles[t.selectedType],m=_e(t.parsedPrices);return l?m?(d||u.push(o?.customer_price?"\u0426\u0435\u043D\u0430 \u0438\u0437 API (\u043D\u0435 \u0441\u043F\u0430\u0440\u0441\u0435\u043D\u0430)":"\u041D\u0435\u0442 \u0446\u0435\u043D\u044B"),(!n||n.qty===0&&n.sum===0)&&u.push("\u041D\u0435\u0442 \u043F\u0440\u043E\u0434\u0430\u0436"),i.length===0&&u.push("\u041D\u0435\u0442 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432")):(!n||n.qty===0&&n.sum===0)&&u.push("\u041D\u0435\u0442 \u043F\u0440\u043E\u0434\u0430\u0436"):u.push("\u0424\u0430\u0439\u043B \u043D\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D"),React.createElement("tr",{key:`hidden-${e.\u0410\u0440\u0442\u0438\u043A\u0443\u043B}-${s}`,className:"text-muted"},React.createElement("td",null,a?React.createElement("img",{src:a,className:"product-img shadow-sm",alt:e.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430,style:{width:"40px",height:"40px"}}):React.createElement("span",{className:"text-muted small"},"\u2014")),React.createElement("td",null,React.createElement("small",null,e.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430),React.createElement("div",{className:"small"},o?.sku?React.createElement("a",{href:`https://www.ozon.ru/product/${o.sku}`,target:"_blank",rel:"noreferrer",className:"text-decoration-none text-muted"},React.createElement("i",{className:"bi bi-link"})," \u0421\u0441\u044B\u043B\u043A\u0430"):React.createElement("span",null,"\u0410\u0440\u0442: ",e.\u0410\u0440\u0442\u0438\u043A\u0443\u043B))),React.createElement("td",null,(()=>{let p=d?.price,c=g=>{let y=parseFloat(g.replace(/[^\d.,]/g,"").replace(",","."))||0;if(y<=0)return g;let w=y*.9;return`${new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(w)} \u20BD`};return p?React.createElement("small",null,c(p)):o?.customer_price?React.createElement("small",null,c(o.customer_price)):React.createElement("small",{className:"text-muted"},"\u2014")})()),React.createElement("td",null,n?.qty?React.createElement("small",null,new Intl.NumberFormat("ru-RU").format(n.qty)):React.createElement("small",{className:"text-muted"},"\u2014")),React.createElement("td",null,n?.sum?React.createElement("small",null,new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(n.sum*(1-(t.ozonPrices[e.\u0410\u0440\u0442\u0438\u043A\u0443\u043B]?.discount_percent||0)))," \u20BD"):React.createElement("small",{className:"text-muted"},"\u2014")),React.createElement("td",null,i.length>0?React.createElement("small",null,i.length," \u0448\u0442"):React.createElement("small",{className:"text-muted"},"\u2014")),React.createElement("td",null,React.createElement("small",{className:"text-muted"},u.join(", "))))}))))),t.selectedType&&Object.keys(t.competitorSelections).some(e=>se.some(s=>s.\u0410\u0440\u0442\u0438\u043A\u0443\u043B===e&&t.competitorSelections[e]?.length>0))&&React.createElement("div",{className:"mb-3"},React.createElement("button",{className:"btn btn-outline-danger btn-sm",onClick:()=>{if(!confirm('\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432 \u0434\u043B\u044F \u0432\u0441\u0435\u0445 \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0432 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 "'+t.selectedType+'"?'))return;let e=se.map(o=>o.\u0410\u0440\u0442\u0438\u043A\u0443\u043B),s={...t.competitorSelections};e.forEach(o=>{delete s[o]}),ee({competitorSelections:s,parsedPrices:t.parsedPrices,uploadedFiles:t.uploadedFiles,lastUpdated:new Date().toISOString()},A).then(()=>{f(o=>({...o,competitorSelections:s})),alert('\u0421\u043F\u0438\u0441\u043E\u043A \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432 \u043E\u0447\u0438\u0449\u0435\u043D \u0434\u043B\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 "'+t.selectedType+'"')})}},React.createElement("i",{className:"bi bi-trash"})," \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0432\u0441\u0435\u0445 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432")),v&&React.createElement("div",{className:"position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center",style:{backgroundColor:"rgba(0,0,0,0.8)",zIndex:1050},onClick:()=>C(null)},React.createElement("div",{className:"position-relative"},React.createElement("img",{src:v,style:{maxHeight:"90vh",maxWidth:"90vw"},alt:"Large preview"}),React.createElement("button",{className:"btn btn-close btn-close-white position-absolute top-0 end-0 m-2",onClick:()=>C(null)}))),Z.competitor&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)",zIndex:1050}},React.createElement("div",{className:"modal-dialog modal-xl modal-dialog-scrollable"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header"},React.createElement("h5",{className:"modal-title"},"\u{1F4CA} \u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0434\u0430\u043D\u043D\u044B\u0445 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u0430"),React.createElement("button",{type:"button",className:"btn-close",onClick:()=>Ne({competitor:null,productName:""})})),React.createElement("div",{className:"modal-body"},React.createElement("div",{className:"row mb-4"},React.createElement("div",{className:"col-md-12"},React.createElement("div",{className:"p-3 bg-light rounded"},React.createElement("h6",null,"\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F \u043E \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u0435:"),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-6"},React.createElement("p",{className:"mb-1"},React.createElement("strong",null,"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435:")," ",Z.competitor.name),React.createElement("p",{className:"mb-1"},React.createElement("strong",null,"\u0422\u043E\u0432\u0430\u0440:")," ",Z.productName)),React.createElement("div",{className:"col-md-6"},React.createElement("p",{className:"mb-1"},React.createElement("strong",null,"\u0411\u0440\u0435\u043D\u0434:")," ",Z.competitor.brand),React.createElement("p",{className:"mb-0"},React.createElement("strong",null,"\u0421\u0441\u044B\u043B\u043A\u0430:"),React.createElement("a",{href:Z.competitor.link,target:"_blank",rel:"noopener noreferrer",className:"ms-2"},React.createElement("i",{className:"bi bi-link"})," \u041F\u0435\u0440\u0435\u0439\u0442\u0438"))))))),React.createElement("div",{className:"row mb-4"},React.createElement("div",{className:"col-md-12"},React.createElement("h6",{className:"mb-3"},"\u{1F4C8} \u0413\u0440\u0430\u0444\u0438\u043A\u0438 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439"),React.createElement(Nt,{priceHistory:Z.competitor.priceHistory}))),React.createElement("div",{className:"row"},React.createElement("div",{className:"col-md-12"},React.createElement("div",{className:"card"},React.createElement("div",{className:"card-header"},React.createElement("h6",{className:"mb-0"},"\u{1F4CB} \u0422\u0430\u0431\u043B\u0438\u0446\u0430 \u0438\u0441\u0442\u043E\u0440\u0438\u0438")),React.createElement("div",{className:"card-body"},Z.competitor.priceHistory&&Z.competitor.priceHistory.length>0?React.createElement("div",{className:"table-responsive"},React.createElement("table",{className:"table table-sm table-hover"},React.createElement("thead",null,React.createElement("tr",null,React.createElement("th",null,"\u0414\u0430\u0442\u0430 \u0438 \u0432\u0440\u0435\u043C\u044F"),React.createElement("th",null,"\u0426\u0435\u043D\u0430 \u043F\u043E Ozon Card"),React.createElement("th",null,"\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442"),React.createElement("th",null,"\u0421\u0443\u043C\u043C\u0430 \u0437\u0430\u043A\u0430\u0437\u0430"),React.createElement("th",null,"\u0418\u0441\u0442\u043E\u0447\u043D\u0438\u043A"))),React.createElement("tbody",null,Z.competitor.priceHistory.sort((e,s)=>new Date(s.date).getTime()-new Date(e.date).getTime()).map((e,s)=>React.createElement("tr",{key:s},React.createElement("td",null,new Date(e.date).toLocaleString("ru-RU")),React.createElement("td",null,React.createElement("span",{className:"badge badge-success"},e.price||"\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445")),React.createElement("td",null,e.qty!==void 0&&e.qty!==""&&e.qty!==0?React.createElement("span",null,e.qty):React.createElement("span",{className:"text-muted",title:e.qty===void 0?"\u0414\u0430\u043D\u043D\u044B\u0435 \u043D\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u044F\u043B\u0438\u0441\u044C (\u043C\u0435\u043D\u0435\u0435 6 \u0434\u043D\u0435\u0439 \u0441 \u043F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0435\u0433\u043E \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F)":"\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445"},"\u2014")),React.createElement("td",null,e.sum!==void 0&&e.sum!==""&&e.sum!==0?React.createElement("span",null,e.sum," \u20BD"):React.createElement("span",{className:"text-muted",title:e.sum===void 0?"\u0414\u0430\u043D\u043D\u044B\u0435 \u043D\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u044F\u043B\u0438\u0441\u044C (\u043C\u0435\u043D\u0435\u0435 6 \u0434\u043D\u0435\u0439 \u0441 \u043F\u0440\u0435\u0434\u044B\u0434\u0443\u0449\u0435\u0433\u043E \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F)":"\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445"},"\u2014")),React.createElement("td",null,e.qty&&e.qty!==""&&e.qty!==0?React.createElement("span",null,e.qty):React.createElement("span",{className:"text-muted"},"\u2014")),React.createElement("td",null,e.sum&&e.sum!==""&&e.sum!==0?React.createElement("span",null,e.sum," \u20BD"):React.createElement("span",{className:"text-muted"},"\u2014")),React.createElement("td",null,React.createElement("span",{className:"badge bg-info text-dark"},e.source)))))),React.createElement("div",{className:"text-muted small mt-2"},"\u0412\u0441\u0435\u0433\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439: ",Z.competitor.priceHistory.length)):React.createElement("div",{className:"text-center text-muted py-4"},React.createElement("i",{className:"bi bi-clock-history fs-1 mb-3 d-block"}),React.createElement("p",null,"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0434\u0430\u043D\u043D\u044B\u0445 \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442"))))))),React.createElement("div",{className:"modal-footer"},React.createElement("button",{type:"button",className:"btn btn-secondary",onClick:()=>Ne({competitor:null,productName:""})},"\u0417\u0430\u043A\u0440\u044B\u0442\u044C"))))),t.activeModalSku&&V&&React.createElement("div",{className:"modal show d-block",style:{backgroundColor:"rgba(0,0,0,0.5)",zIndex:1040}},React.createElement("div",{className:"modal-dialog modal-xl modal-dialog-scrollable"},React.createElement("div",{className:"modal-content"},React.createElement("div",{className:"modal-header border-bottom"},React.createElement("h5",{className:"modal-title fw-semibold"},"\u0412\u044B\u0431\u043E\u0440 \u043A\u043E\u043D\u043A\u0443\u0440\u0435\u043D\u0442\u043E\u0432 \u0434\u043B\u044F: ",React.createElement("span",{className:"fw-medium"},ut?.\u041D\u043E\u043C\u0435\u043D\u043A\u043B\u0430\u0442\u0443\u0440\u0430)),React.createElement("button",{type:"button",className:"btn-close",onClick:De})),React.createElement("div",{className:"p-3 border-bottom bg-light-subtle"},(()=>{let e=qe(),s=he(),o=s&&$?at($):[],a=$?s?_?Ee($,_):[]:Ee($):[];return React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"d-flex align-items-center mb-2"},React.createElement("i",{className:"bi bi-award me-2 text-muted"}),React.createElement("span",{className:"text-muted"},"\u0422\u043E\u043F-5 \u0431\u0440\u0435\u043D\u0434\u043E\u0432 \u043F\u043E \u043F\u0440\u043E\u0434\u0430\u0436\u0430\u043C:"),($||L||_)&&React.createElement("button",{className:"btn btn-sm btn-link text-muted ms-2 p-0",onClick:()=>{W(null),B(null),U(null)}},"\u0421\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u0444\u0438\u043B\u044C\u0442\u0440\u044B")),React.createElement("div",{className:"d-flex flex-wrap gap-2"},e.map((r,n)=>React.createElement("button",{key:r.name,className:`btn btn-sm ${$===r.name?"btn-secondary":"btn-outline-secondary"}`,onClick:()=>{U($===r.name?null:r.name),B(null),W(null)},style:{fontSize:"14px",fontWeight:$===r.name?"500":"normal"}},React.createElement("span",{className:"badge bg-light text-dark me-1"},"#",n+1),r.name,React.createElement("span",{className:"badge bg-light text-muted ms-1"},r.count," \u043F\u043E\u0437."),React.createElement("span",{className:"badge bg-light text-muted ms-1"},new Intl.NumberFormat("ru-RU",{notation:"compact",compactDisplay:"short"}).format(r.totalSum)," \u20BD"))))),s&&$&&o.length>0&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"d-flex align-items-center mb-2"},React.createElement("i",{className:"bi bi-droplet me-2 text-muted"}),React.createElement("span",{className:"text-muted"},'\u0412\u044F\u0437\u043A\u043E\u0441\u0442\u0438 \u0434\u043B\u044F \u0431\u0440\u0435\u043D\u0434\u0430 "',$,'":')),React.createElement("div",{className:"d-flex flex-wrap gap-2"},o.map(r=>React.createElement("button",{key:r.name,className:`btn btn-sm ${_===r.name?"btn-secondary":"btn-outline-secondary"}`,onClick:()=>{B(_===r.name?null:r.name),W(null)},style:{fontSize:"14px",fontWeight:_===r.name?"500":"normal"}},r.name,React.createElement("span",{className:"badge bg-light text-muted ms-1"},r.count," \u043F\u043E\u0437."))))),$&&a.length>0&&(!s||_)&&React.createElement("div",{className:"mb-3"},React.createElement("div",{className:"d-flex align-items-center mb-2"},React.createElement("i",{className:"bi bi-box-seam me-2 text-muted"}),React.createElement("span",{className:"text-muted"},"\u041E\u0431\u044A\u0451\u043C\u044B",s&&_?` \u0434\u043B\u044F ${_}`:"",' \u0431\u0440\u0435\u043D\u0434\u0430 "',$,'":')),React.createElement("div",{className:"d-flex flex-wrap gap-2"},a.map(r=>React.createElement("button",{key:r.name,className:`btn btn-sm ${L===r.name?"btn-secondary":"btn-outline-secondary"}`,onClick:()=>{W(L===r.name?null:r.name)},style:{fontSize:"14px",fontWeight:L===r.name?"500":"normal"}},r.name,React.createElement("span",{className:"badge bg-light text-muted ms-1"},r.count," \u043F\u043E\u0437."))))))})(),React.createElement("div",{className:"row g-3"},React.createElement("div",{className:"col-md-8"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-text bg-white border-end-0"},React.createElement("i",{className:"bi bi-search text-muted"})),React.createElement("input",{type:"text",className:"form-control border-start-0",placeholder:"\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044E, \u0431\u0440\u0435\u043D\u0434\u0443 \u0438\u043B\u0438 SKU...",onChange:e=>{let s=e.target.value.toLowerCase(),o=V;if(!o||o.length<2)return;let a=Y(o);if(a.name===-1||a.link===-1||a.brand===-1||a.qty===-1||a.sum===-1){console.error("\u274C \u041D\u0435 \u0432\u0441\u0435 \u043A\u043E\u043B\u043E\u043D\u043A\u0438 \u043D\u0430\u0439\u0434\u0435\u043D\u044B \u0434\u043B\u044F \u043F\u043E\u0438\u0441\u043A\u0430:",a);return}if(!s.trim()){f(i=>({...i,searchTerm:"",filteredRows:null}));return}let r=[];for(let i=1;i<o.length;i++){let d=o[i],u=!1;try{if(a.name!==-1&&d[a.name]&&String(d[a.name]).toLowerCase().includes(s)&&(u=!0),!u&&a.brand!==-1&&d[a.brand]&&String(d[a.brand]).toLowerCase().includes(s)&&(u=!0),!u&&a.link!==-1&&d[a.link]){let l=String(d[a.link]),m=ge(l);m&&m.toLowerCase().includes(s)&&(u=!0),!u&&l.toLowerCase().includes(s)&&(u=!0)}u&&r.push(i)}catch(l){console.error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0435 \u0441\u0442\u0440\u043E\u043A\u0438 ${i}:`,l)}}let n=new Set;z.forEach(i=>{r.includes(i)&&n.add(i)}),f(i=>({...i,searchTerm:s,filteredRows:s?r:null})),T(n)}}))),React.createElement("div",{className:"col-md-4 d-flex justify-content-between align-items-center"},React.createElement("span",{className:"badge bg-light text-dark border"},V.length-1," \u0441\u0442\u0440\u043E\u043A"),React.createElement("div",{className:"text-muted small"},z.size," \u0432\u044B\u0431\u0440\u0430\u043D\u043E")))),React.createElement("div",{className:"modal-body p-0"},React.createElement("div",{className:"table-responsive",style:{maxHeight:"50vh"}},React.createElement("table",{className:"table table-hover table-borderless mb-0"},React.createElement("thead",{className:"sticky-top",style:{top:0,backgroundColor:"#f8f9fa"}},React.createElement("tr",{className:"border-bottom"},React.createElement("th",{style:{width:"50px"},className:"text-center ps-4"},React.createElement("div",{className:"form-check"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:z.size>0&&z.size===ye().length,onChange:e=>{let s=ye();if(e.target.checked){let o=new Set(s);T(o)}else T(new Set)}}))),React.createElement("th",{style:{width:"100px"},className:"fw-semibold"},"\u041E\u0431\u044A\u0451\u043C"),React.createElement("th",{style:{minWidth:"300px"},className:"fw-semibold"},"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430"),React.createElement("th",{style:{width:"200px"},className:"fw-semibold"},"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0442\u043E\u0432\u0430\u0440"),React.createElement("th",{style:{width:"120px"},className:"fw-semibold"},"\u0411\u0440\u0435\u043D\u0434"),React.createElement("th",{style:{width:"120px"},className:"fw-semibold text-end"},"\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E, \u0448\u0442\u0443\u043A\u0438"),React.createElement("th",{style:{width:"150px"},className:"fw-semibold text-end pe-4"},"\u0417\u0430\u043A\u0430\u0437\u0430\u043D\u043E \u043D\u0430 \u0441\u0443\u043C\u043C\u0443, \u20BD"))),React.createElement("tbody",null,ye().map(e=>{let s=V[e],o=z.has(e),a=Y(V);if(a.name===-1||a.link===-1||a.brand===-1||a.qty===-1||a.sum===-1)return console.error("\u274C \u041D\u0435 \u0432\u0441\u0435 \u043A\u043E\u043B\u043E\u043D\u043A\u0438 \u043D\u0430\u0439\u0434\u0435\u043D\u044B \u0432 mapping:",a),null;let r=s[a.name]!==void 0?String(s[a.name]).trim():"\u041D\u0435\u0442 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",n=s[a.link]!==void 0?String(s[a.link]).trim():"#",i=s[a.brand]!==void 0?String(s[a.brand]).trim():"-",d=me(r),u="";if(s[a.qty]!==void 0&&s[a.qty]!==null){let p=s[a.qty];typeof p=="number"?u=new Intl.NumberFormat("ru-RU").format(p):u=String(p).trim()}let l="";if(s[a.sum]!==void 0&&s[a.sum]!==null){let p=s[a.sum];if(typeof p=="number")l=new Intl.NumberFormat("ru-RU",{minimumFractionDigits:0,maximumFractionDigits:0}).format(p)+" \u20BD";else{let c=String(p).trim();l=c?c.includes("\u20BD")?c:c+" \u20BD":""}}let m=ge(n);return React.createElement("tr",{key:e,onClick:()=>st(e),className:`${o?"selected-row":""} border-bottom`},React.createElement("td",{className:"text-center align-middle ps-4"},React.createElement("div",{className:"form-check"},React.createElement("input",{type:"checkbox",className:"form-check-input",checked:o,readOnly:!0,style:{width:"18px",height:"18px"}}))),React.createElement("td",{className:"align-middle"},React.createElement("span",{className:"badge bg-light text-dark border"},d)),React.createElement("td",{className:"align-middle"},React.createElement("div",{className:"d-flex flex-column"},React.createElement("div",{title:r,style:{wordBreak:"break-word"}},r),m&&React.createElement("div",{className:"small text-muted mt-1"},React.createElement("span",{className:"badge bg-light text-dark border"},"SKU: ",m)))),React.createElement("td",{className:"align-middle"},React.createElement("a",{href:n,target:"_blank",rel:"noopener noreferrer",className:"text-decoration-none d-flex align-items-center text-muted",onClick:p=>p.stopPropagation()},React.createElement("span",{className:"text-truncate d-inline-block",style:{maxWidth:"180px"},title:n},n.replace(/^https?:\/\/(www\.)?/,"").split("/")[0]||"\u0421\u0441\u044B\u043B\u043A\u0430"),React.createElement("i",{className:"bi bi-box-arrow-up-right ms-2 small"}))),React.createElement("td",{className:"align-middle"},React.createElement("span",{className:"badge bg-light text-dark border"},i)),React.createElement("td",{className:"align-middle text-end"},u?React.createElement("span",null,u):React.createElement("span",{className:"text-muted"},"\u2014")),React.createElement("td",{className:"align-middle text-end pe-4"},l?React.createElement("span",null,l):React.createElement("span",{className:"text-muted"},"\u2014")))}))))),React.createElement("div",{className:"modal-footer border-top"},React.createElement("div",{className:"d-flex justify-content-between align-items-center w-100"},React.createElement("div",{className:"text-muted small"},"\u041F\u043E\u043A\u0430\u0437\u0430\u043D\u043E: ",ye().length," \u0438\u0437 ",V.length-1," \u0441\u0442\u0440\u043E\u043A"),React.createElement("div",null,React.createElement("button",{type:"button",className:"btn btn-outline-secondary me-2",onClick:De},"\u041E\u0442\u043C\u0435\u043D\u0430"),React.createElement("button",{type:"button",className:"btn btn-primary",onClick:tt},"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 (",z.size,")"))))))))},xt=yt(document.getElementById("root"));xt.render(React.createElement(St,null));})();
